<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Ops: Infinite War - Ultimate Balance</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-user-select: none; touch-action: none; }
        body { background: #000; overflow: hidden; font-family: 'Rajdhani', sans-serif; color: white; }
        canvas { display: block; background: #111; }

        /* UI LAYER */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: none; }

        /* Topo */
        .top-bar { position: absolute; top: 10px; left: 10px; right: 10px; display: flex; justify-content: space-between; align-items: flex-start; pointer-events: auto; }
        .bars { display: flex; flex-direction: column; gap: 4px; pointer-events: none; }
        .bar-bg { width: 130px; height: 12px; background: #222; border: 1px solid #555; transform: skewX(-15deg); }
        .hp-fill { width: 100%; height: 100%; background: #f00; transition: width 0.2s ease-out; } 
        .sh-fill { width: 0%; height: 100%; background: #00aaff; } 
        
        .info { text-align: right; text-shadow: 1px 1px 2px black; pointer-events: none; }
        .lvl { font-size: 24px; color: #ffeb3b; font-weight: bold; display: block;}
        .score { font-size: 18px; color: #fff; display: block; }
        .money { font-size: 20px; color: #0f0; display: block;}

        /* Status Effects */
        #status-effects { position: absolute; top: 60px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; pointer-events: none; }
        .status-badge { padding: 5px 10px; border-radius: 5px; font-weight: bold; font-size: 14px; animation: blink 0.5s infinite alternate; text-shadow: 0 0 5px black; }
        .st-slow { background: #d35400; color: white; border: 1px solid #e67e22; }
        .st-jam { background: #2980b9; color: white; border: 1px solid #3498db; }
        .st-god { background: #ffd700; color: black; border: 2px solid #fff; box-shadow: 0 0 10px #ffd700; }

        /* Bot√£o Pause */
        #pause-btn {
            background: rgba(0,0,0,0.5); border: 2px solid #fff; color: white;
            width: 40px; height: 40px; border-radius: 5px; font-weight: bold;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            pointer-events: auto; margin-left: 10px;
        }

        /* Radar */
        #radar {
            position: absolute; top: 60px; left: 10px;
            width: 90px; height: 90px;
            background: rgba(0, 20, 0, 0.6);
            border: 2px solid #0f0; border-radius: 50%;
            pointer-events: none; overflow: hidden;
        }
        #radar-canvas { width: 100%; height: 100%; }

        /* M√°quinas */
        .machines { 
            position: absolute; 
            right: 15px; 
            top: auto;
            bottom: 260px; 
            display: flex; flex-direction: column; gap: 15px; pointer-events: auto; 
            transition: all 0.3s;
        }
        
        .m-icon { width: 55px; height: 55px; background: rgba(0,0,0,0.7); border: 2px solid #0ff; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: 24px; position: relative; margin-bottom: 5px; }
        .m-icon:active { transform: scale(0.9); background: rgba(0,255,255,0.3); }
        .m-qty { position: absolute; bottom: -2px; right: -2px; background: #f00; font-size: 10px; padding: 1px 4px; border-radius: 3px; font-weight: bold; }

        /* Bot√£o Nuclear - CENTRALIZA√á√ÉO FIXA */
        #nuke-container {
            position: absolute; 
            top: 100px; 
            left: 0; right: 0; margin: 0 auto; 
            width: 80px; height: 80px; z-index: 100; pointer-events: auto;
            display: none; justify-content: center; align-items: center;
        }
        #nuke-btn {
            width: 70px; height: 70px; background: radial-gradient(#ff0, #f00);
            border: 3px solid #fff; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 30px; animation: pulse 0.5s infinite;
            box-shadow: 0 0 20px #f00; cursor: pointer;
        }
        #nuke-btn:active { transform: scale(0.9); }

        .w-btn {
            position: absolute; bottom: 170px;
            width: 70px; height: 70px; border-radius: 50%;
            background: rgba(0,0,0,0.6); border: 2px solid #fff; display: flex; flex-direction: column;
            justify-content: center; align-items: center; pointer-events: auto; z-index: 20;
            transition: all 0.3s;
        }
        .w-name { font-size: 10px; font-weight: bold; }
        .w-ammo { font-size: 16px; }

        /* Bot√£o Tiro Manual */
        #fire-btn {
            position: absolute; bottom: 40px; width: 90px; height: 90px; border-radius: 50%;
            background: rgba(255, 50, 50, 0.4); border: 4px solid #f00;
            display: flex; justify-content: center; align-items: center; pointer-events: auto; z-index: 20;
            box-shadow: 0 0 15px #f00; font-weight: bold; font-size: 20px; transition: all 0.3s;
        }
        #fire-btn:active { background: rgba(255, 50, 50, 0.7); transform: scale(0.95); }

        /* Joysticks */
        .joy-zone {
            position: absolute; bottom: 40px; width: 140px; height: 140px;
            background: rgba(255, 255, 255, 0.05); border-radius: 50%;
            border: 2px dashed rgba(255, 255, 255, 0.15);
            pointer-events: auto; display: flex; justify-content: center; align-items: center;
            transition: all 0.3s;
        }
        .knob { width: 50px; height: 50px; background: rgba(0, 255, 255, 0.4); border-radius: 50%; pointer-events: none; }
        .k-red { background: rgba(255, 50, 50, 0.4); }
        .k-green { width: 70px; height: 70px; background: rgba(0, 255, 0, 0.4); }

        .pos-left { left: 30px; right: auto; }
        .pos-right { right: 30px; left: auto; }
        .pos-center { left: 50%; transform: translateX(-50%); }

        /* Menus */
        .modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 10, 15, 0.98); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100; pointer-events: auto;
            overflow-y: auto; padding: 20px;
        }
        .hidden { display: none !important; }

        h1 { color: #0ff; font-size: 32px; margin-bottom: 10px; text-align: center; text-transform: uppercase; }
        h2 { color: #ffeb3b; margin: 10px 0; font-size: 22px; }
        
        .btn {
            background: linear-gradient(45deg, #00aaff, #0055ff); border: none; padding: 12px 25px;
            color: white; font-family: 'Rajdhani'; font-size: 18px; font-weight: bold;
            margin: 8px; border-radius: 5px; min-width: 250px; cursor: pointer;
        }
        .btn:active { transform: scale(0.95); }
        .btn-green { background: linear-gradient(45deg, #00aa00, #00ff00); color: black; }
        .btn-red { background: linear-gradient(45deg, #aa0000, #ff0000); color: white; }
        .btn-shop { background: #333; border: 1px solid #555; display: flex; justify-content: space-between; align-items: center; width: 280px; padding: 10px; margin: 5px 0; cursor: pointer;}
        
        .perk-container { display: flex; gap: 8px; }
        .perk { background: #222; border: 1px solid #444; padding: 10px; border-radius: 8px; width: 85px; text-align: center; cursor: pointer;}
        .perk:active { border-color: #0ff; background: #333; }

        .color-picker { display: flex; gap: 10px; margin: 15px 0; }
        .c-opt { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #555; cursor: pointer; }
        .c-opt.selected { border-color: #fff; box-shadow: 0 0 10px white; }

        .report-table { width: 100%; max-width: 300px; border-collapse: collapse; margin-bottom: 20px; color: #ccc; }
        .report-table td { padding: 5px; border-bottom: 1px solid #333; }
        .report-table td:last-child { text-align: right; color: #fff; font-weight: bold; }
        
        .rank-table { width: 100%; max-width: 400px; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        .rank-table th { background: #222; padding: 8px; color: #0ff; text-align: left; }
        .rank-table td { padding: 8px; border-bottom: 1px solid #333; }
        .rank-table tr:nth-child(even) { background: rgba(255,255,255,0.05); }
        
        .name-input {
            padding: 10px; font-size: 18px; border: 2px solid #0ff; background: #111; color: white;
            text-align: center; font-family: 'Rajdhani'; border-radius: 5px; margin-bottom: 15px; width: 250px;
        }
        .num-input {
            width: 100px; text-align: center; font-size: 18px; padding: 5px; background: #222; color: #fff; border: 1px solid #555; margin-bottom: 10px;
        }

        @keyframes pulse { 
            0% { transform: scale(1); } 
            50% { transform: scale(1.1); box-shadow: 0 0 20px red; } 
            100% { transform: scale(1); } 
        }
        @keyframes blink { 0% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div class="top-bar">
            <div style="display:flex; align-items:center;">
                <div class="bars">
                    <div class="bar-bg"><div class="hp-fill" id="hpBar"></div></div>
                    <div class="bar-bg" style="width: 130px; height: 6px; margin-top:2px;"><div class="sh-fill" id="shBar"></div></div>
                </div>
                <div id="pause-btn" onclick="togglePause()">||</div>
            </div>
            <div class="info">
                <div class="lvl" id="lvlDisp">N√çVEL 1</div>
                <div class="score" id="scoreDisp">0 PTS</div>
                <div class="money" id="moneyDisp">$0</div>
            </div>
        </div>

        <div id="status-effects"></div>
        <div id="radar"><canvas id="radar-canvas"></canvas></div>
        
        <div id="nuke-container" ontouchstart="useNuke(event)" onmousedown="useNuke(event)">
            <div id="nuke-btn">‚ò¢Ô∏è</div>
        </div>

        <div class="machines">
            <div class="m-icon" ontouchstart="spawnMachine(event, 'turret')" onmousedown="spawnMachine(event, 'turret')">üî´<div class="m-qty" id="q-turret">0</div></div>
            <div class="m-icon" ontouchstart="spawnMachine(event, 'missile')" onmousedown="spawnMachine(event, 'missile')">üöÄ<div class="m-qty" id="q-missile">0</div></div>
            <div class="m-icon" ontouchstart="spawnMachine(event, 'grenade')" onmousedown="spawnMachine(event, 'grenade')">üí£<div class="m-qty" id="q-grenade">0</div></div>
        </div>

        <div class="w-btn right" id="swapBtn">
            <div class="w-name" id="wName">PISTOLA</div>
            <div class="w-ammo" id="wAmmo">‚àû</div>
        </div>

        <div id="fire-btn" class="hidden">TIRO</div>

        <div id="joy-move" class="joy-zone pos-left"><div class="knob" id="knob-move"></div></div>
        <div id="joy-aim" class="joy-zone pos-right"><div class="knob k-red" id="knob-aim"></div></div>
        <div id="joy-single" class="joy-zone pos-center hidden"><div class="knob k-green" id="knob-single"></div></div>
    </div>

    <div id="startMenu" class="modal">
        <h1>NEON OPS<br><span style="font-size:16px; color:white;">INFINITE WAR</span></h1>
        
        <div style="margin: 10px 0; text-align: center;">
            <p style="color:#aaa; font-size:14px; margin-bottom:5px;">N√≠vel Inicial:</p>
            <input type="number" id="startLevelInput" class="num-input" value="1" min="1" max="500">
            <p style="color:#777; font-size:10px;">(Come√ßar >1 desativa Ranking)</p>
        </div>

        <p style="color:#aaa; font-size:14px;">Cor do Agente</p>
        <div class="color-picker">
            <div class="c-opt selected" style="background:#0ff" onclick="setColor('#0ff', this)"></div>
            <div class="c-opt" style="background:#0f0" onclick="setColor('#0f0', this)"></div>
            <div class="c-opt" style="background:#f0f" onclick="setColor('#f0f', this)"></div>
            <div class="c-opt" style="background:#ff0" onclick="setColor('#ff0', this)"></div>
        </div>

        <button class="btn" onclick="startGame()">INICIAR MISS√ÉO</button>
        <button class="btn btn-shop" style="justify-content:center;" onclick="showLeaderboard()">üèÜ HIST√ìRICO GERAL</button>
        <button class="btn btn-shop" id="btnGodMode" style="justify-content:center; border-color:#555;" onclick="toggleGodMode()">MODO DEUS: DESATIVADO</button>
        
        <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px; align-items:center;">
            <button class="btn btn-shop" style="width:250px; font-size:14px;" id="btnModeStart" onclick="cycleControlMode()">CONTROLE: DUPLO</button>
            <button class="btn btn-shop" style="width:250px; font-size:14px;" id="btnSwapStart" onclick="toggleSide()">LADO: PADR√ÉO</button>
        </div>
    </div>

    <div id="leaderboardMenu" class="modal hidden">
        <h1>HALL DA FAMA</h1>
        <div style="max-height: 60%; overflow-y: auto; width: 100%; display:flex; justify-content:center;">
            <table class="rank-table">
                <thead><tr><th>#</th><th>NOME</th><th>N√çVEL</th><th>SCORE</th></tr></thead>
                <tbody id="leaderboardBody"></tbody>
            </table>
        </div>
        <button class="btn" style="margin-top:20px;" onclick="closeLeaderboard()">VOLTAR</button>
    </div>

    <div id="pauseMenu" class="modal hidden">
        <h1>PAUSA</h1>
        <button class="btn" onclick="togglePause()">CONTINUAR</button>
        <button class="btn btn-shop" style="justify-content:center;" id="btnModePause" onclick="cycleControlMode()">MUDAR TIPO CONTROLE</button>
        <button class="btn btn-shop" style="justify-content:center;" id="btnSwapPause" onclick="toggleSide()">LADO: PADR√ÉO</button>
        <button class="btn btn-red" onclick="returnToMenu()">VOLTAR AO MENU</button>
    </div>

    <div id="shopMenu" class="modal hidden">
        <h2 id="shopTitle">MISS√ÉO CUMPRIDA!</h2>
        <p id="freePerksMsg" style="color:#ff0; font-weight:bold; display:none;"></p>

        <div style="display:flex; gap:15px; font-size:14px; margin-bottom:10px; color:#ccc;">
            <div>Dano: <span id="stat-dmg" style="color:#0ff">100%</span></div>
            <div>Vida: <span id="stat-hp" style="color:#0f0">100%</span></div>
            <div>Sorte: <span id="stat-luck" style="color:#f0f">1.0x</span></div>
        </div>

        <div id="perkSection">
            <p style="color:#aaa; margin:5px; font-size:14px;">Escolha uma Melhoria:</p>
            <div class="perk-container">
                <div class="perk" onclick="pickPerk('dmg')">‚öîÔ∏è<br>+20% Dano</div>
                <div class="perk" onclick="pickPerk('hp')">‚ù§Ô∏è<br>+10% Vida</div>
                <div class="perk" onclick="pickPerk('luck')">üçÄ<br>+Sorte</div>
            </div>
        </div>
        <div id="perkMsg" class="hidden" style="color:#0f0; margin:10px; font-weight:bold;">MELHORIA APLICADA!</div>
        
        <h2 style="margin-top:15px; color:#0f0; font-size:18px;">LOJA ($<span id="shopMoney">0</span>)</h2>
        <div class="btn-shop" onclick="buyItem('turret', 200)"><span>Torreta</span> <span style="color:#0f0">$200</span></div>
        <div class="btn-shop" onclick="buyItem('missile', 100)"><span>M√≠ssil x3</span> <span style="color:#0f0">$100</span></div>
        <div class="btn-shop" onclick="buyItem('grenade', 50)"><span>Granada x2</span> <span style="color:#0f0">$50</span></div>
        
        <div class="btn-shop" id="btnBuyShield" onclick="buyItem('shield', 200)">
            <span>Escudo Inicial</span> <span id="priceShield" style="color:#0af">$200</span>
        </div>
        
        <div class="btn-shop" id="btnBuyNuke" onclick="buyItem('nuke', 1000)">
            <span>Bomba Nuclear</span> <span style="color:#f00">$1000</span>
        </div>

        <button class="btn btn-green hidden" id="btnNextLevel" style="margin-top:20px;" onclick="nextLevel()">PR√ìXIMA MISS√ÉO</button>
    </div>

    <div id="deadMenu" class="modal hidden">
        <h1 style="color:red">FIM DE JOGO</h1>
        <h2 id="finalScore">SCORE: 0</h2>
        <h3 id="finalLevelDisplay" style="color:#0ff; margin-bottom:10px;">N√çVEL ALCAN√áADO: 1</h3>
        
        <div id="rankForm">
            <p style="color:#aaa; font-size:14px; margin-bottom:5px;">REGISTRE SEU NOME:</p>
            <input type="text" id="playerNameInput" class="name-input" placeholder="AGENTE..." maxlength="10">
            <button class="btn btn-green" id="btnSaveScore" onclick="saveCurrentScore()">SALVAR RECORDE</button>
        </div>
        <div id="saveMsg" class="hidden" style="color:#0f0; margin-bottom:10px;">SALVO!</div>
        <div id="noRankMsg" class="hidden" style="color:#888; font-style:italic; margin-bottom:10px;">Ranking desativado (In√≠cio Avan√ßado / God Mode)</div>

        <h3>RELAT√ìRIO</h3>
        <table class="report-table" id="reportTable"></table>
        <button class="btn" onclick="returnToMenu()">MENU PRINCIPAL</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        const radarCanvas = document.getElementById('radar-canvas');
        const rctx = radarCanvas.getContext('2d');

        let loopId = null;
        let nukeEffect = { active: false, r: 0, alpha: 0 };

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            radarCanvas.width = 100; radarCanvas.height = 100;
        }
        window.addEventListener('resize', resize);
        resize();

        const AudioSys = {
            ctx: null,
            init: function() { if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            playTone: function(freq, type, dur, vol = 0.1) {
                if(!this.ctx) return;
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + dur);
            },
            shoot: function(wId) {
                this.init();
                if(wId===0) this.playTone(600, 'triangle', 0.1); 
                else if(wId===1) this.playTone(300, 'square', 0.15); 
                else { this.playTone(100, 'sawtooth', 0.2); this.playTone(120, 'sawtooth', 0.2); }
            },
            pickup: function() { this.init(); this.playTone(800, 'sine', 0.2); },
            zap: function() { this.init(); this.playTone(150, 'sawtooth', 0.3); }
        };

        const GAME = {
            active: false, paused: false, level: 1, width: 2500, height: 2500,
            camera: {x:0, y:0}, shake:0, money:0, score: 0,
            perks: { dmg:1, hpMult:1, luck:1 },
            inv: { turret:0, missile:0, grenade:0 },
            boughtShield: false,
            killStreak: 0, nukeReady: false, botsAlive: 0,
            playerColor: '#0ff',
            stats: { basic:0, rusher:0, sniper:0, boss:0 },
            controlMode: 'dual', inverted: false,
            freePerksAvailable: 0, 
            validRank: true,
            godMode: false,
            maxBotsOnScreen: 10, 
            botsToSpawn: 0
        };

        const INPUT = { 
            move: {x:0, y:0, active:false, id:null}, 
            aim: {x:0, y:0, active:false, id:null},
            single: {x:0, y:0, active:false, id:null},
            manualFire: false
        };

        const WEAPONS = [
            { id:0, name:'PISTOLA', dmg:25, rate:400, speed:15, spread:0.05, count:1, ammo:'‚àû', max:Infinity, color:'#fff' },
            { id:1, name:'RIFLE', dmg:15, rate:100, speed:22, spread:0.1, count:1, ammo:120, max:120, color:'#0ff' },
            { id:2, name:'SHOTGUN', dmg:12, rate:900, speed:18, spread:0.3, count:6, ammo:30, max:30, color:'#ff0' }
        ];

        class Player {
            constructor(x, y) {
                this.x = x; this.y = y; this.r = 20; 
                this.baseHp = 500; 
                this.hp = this.baseHp * GAME.perks.hpMult; 
                this.maxHp = this.hp; 
                this.shield = 0; this.wIdx = 0; this.lastShot = 0;
                this.angle = 0; this.regenTimer = 0;
                this.slowTimer = 0; this.jamTimer = 0;
                this.invulTimer = 0; 
            }
            update() {
                let speedMult = 1;
                if(this.slowTimer > 0) { speedMult = 0.5; this.slowTimer--; }
                if(this.jamTimer > 0) { this.jamTimer--; }
                if(this.invulTimer > 0) { this.invulTimer--; } 

                const statusDiv = document.getElementById('status-effects');
                let statusHtml = '';
                if(GAME.godMode) statusHtml += '<div class="status-badge st-god">GOD MODE</div>'; 
                if(this.slowTimer > 0) statusHtml += '<div class="status-badge st-slow">LENTO</div>';
                if(this.jamTimer > 0) statusHtml += '<div class="status-badge st-jam">TRAVADO</div>';
                statusDiv.innerHTML = statusHtml;

                let moving = false;

                if (GAME.controlMode === 'single_auto' || GAME.controlMode === 'single_manual') {
                    if(INPUT.single.active) {
                        this.move(INPUT.single.x, INPUT.single.y, speedMult);
                        this.angle = Math.atan2(INPUT.single.y, INPUT.single.x);
                        moving = true;
                    }
                    let target = getNearestTarget(500);
                    if (target) this.angle = Math.atan2(target.y - this.y, target.x - this.x);
                    if (GAME.controlMode === 'single_auto' && target) this.shoot();
                    if (GAME.controlMode === 'single_manual' && INPUT.manualFire) this.shoot();
                } else {
                    if(INPUT.move.active) {
                        this.move(INPUT.move.x, INPUT.move.y, speedMult);
                        if (!INPUT.aim.active) this.angle = Math.atan2(INPUT.move.y, INPUT.move.x);
                        moving = true;
                    }
                    if(INPUT.aim.active) {
                        this.angle = Math.atan2(INPUT.aim.y, INPUT.aim.x);
                        if(Math.hypot(INPUT.aim.x, INPUT.aim.y) > 0.4) this.shoot();
                    }
                }

                this.x = Math.max(20, Math.min(GAME.width-20, this.x));
                this.y = Math.max(20, Math.min(GAME.height-20, this.y));
                
                this.maxHp = this.baseHp * GAME.perks.hpMult;

                if (this.regenTimer > 0) this.regenTimer--;
                else if (this.hp < this.maxHp && this.hp > 0) {
                    this.hp += moving ? 0.05 : 0.2; 
                    if(this.hp > this.maxHp) this.hp = this.maxHp;
                }
                
                if(this.shield > 0) {
                    this.shield -= 0.166; 
                    if(this.shield < 0) this.shield = 0;
                }
                
                document.getElementById('hpBar').style.width = (this.hp/this.maxHp*100) + '%';
                document.getElementById('shBar').style.width = Math.max(0, this.shield) + '%';
            }
            move(dx, dy, mult) {
                this.x += dx * 4 * mult;
                this.y += dy * 4 * mult;
            }
            shoot() {
                if(this.jamTimer > 0) return;
                
                let w = WEAPONS[this.wIdx];
                if (w.ammo !== '‚àû' && w.ammo <= 0) {
                    if(WEAPONS[2].ammo > 0) this.wIdx = 2; 
                    else if(WEAPONS[1].ammo > 0) this.wIdx = 1; 
                    else this.wIdx = 0; 
                    w = WEAPONS[this.wIdx];
                    updateHUD();
                }

                if(Date.now()-this.lastShot > w.rate) {
                    if(w.ammo !== '‚àû' && w.ammo <= 0) return;
                    
                    if(w.ammo !== '‚àû') w.ammo--;
                    this.lastShot = Date.now();
                    GAME.shake = 4; updateHUD();
                    AudioSys.shoot(this.wIdx);
                    for(let i=0; i<w.count; i++) {
                        const s = (Math.random()-0.5) * w.spread;
                        bullets.push({
                            x: this.x + Math.cos(this.angle)*25, y: this.y + Math.sin(this.angle)*25,
                            vx: Math.cos(this.angle+s) * w.speed, vy: Math.sin(this.angle+s) * w.speed,
                            dmg: w.dmg * GAME.perks.dmg, color: GAME.playerColor, player: true, life: 80
                        });
                    }
                }
            }
            takeDamage(amt) {
                if(GAME.godMode) return; 
                if(this.invulTimer > 0) return; 

                // ESCUDO AGORA √â T√ÅTICO: PERDE 20% FIXO POR TIRO (TANCA 5 HITS)
                // Isso o torna efetivo em qualquer n√≠vel
                if(this.shield > 0) {
                    this.shield -= 20; 
                    if(this.shield < 0) this.shield = 0;
                    showText(this.x, this.y, "BLOQUEADO!", "#0af");
                    this.invulTimer = 30; 
                    // N√ÉO RESETA KILLSTREAK
                    return;
                }
                
                // HP
                this.hp -= amt; this.regenTimer = 300; 
                this.invulTimer = 60; 
                GAME.killStreak = 0; updateNuke(); GAME.shake = 10;
                if(this.hp <= 0) gameOver();
            }
            draw() {
                if(!onScreen(this.x, this.y, 50)) return;
                if(this.invulTimer > 0 && !GAME.godMode && this.invulTimer % 10 < 5) return;

                ctx.save(); ctx.translate(this.x, this.y);
                if(this.shield > 0) { ctx.beginPath(); ctx.arc(0,0,28,0,Math.PI*2); ctx.strokeStyle='#0af'; ctx.lineWidth=3; ctx.stroke(); }
                
                ctx.rotate(this.angle);
                ctx.beginPath(); ctx.arc(0,0,20,0,Math.PI*2); ctx.fillStyle=GAME.playerColor; ctx.fill();
                
                if(GAME.godMode) { 
                    ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 2; ctx.stroke();
                }

                ctx.fillStyle='#333'; ctx.fillRect(10,-5,20,10);
                ctx.restore();
            }
        }

        class Bot {
            constructor(x, y, type) {
                this.x=x; this.y=y; this.type=type; 
                this.lastShot = Date.now() + (Math.random() * 2000) + 500;
                this.hp = 50 * (1 + GAME.level*0.1); 
                this.r=22; this.color='#f00'; this.speed=2; this.view=1000;
                this.killedByNuke = false;
                this.shootPattern = 0; 

                if(type === 'boss') {
                    this.hp = 2000 + (GAME.level*100); this.maxHp=this.hp; this.r=60; this.view=2000;
                    if(Math.random()<0.33) { this.color='#fff'; this.speed=1.0; } 
                    else if(Math.random()<0.5) { this.color='#fa0'; this.speed=2.5; } 
                    else { this.color='#b0f'; this.speed=1.2; } 
                } 
                else if(type === 'rusher') { this.hp*=0.6; this.r=18; this.color='#ff0'; this.speed=3.5; }
                else if(type === 'sniper') { this.hp*=0.8; this.r=22; this.color='#b0f'; this.speed=1.5; this.view=1200; }
            }
            update() {
                const dx=player.x-this.x, dy=player.y-this.y;
                const dist=Math.hypot(dx, dy), angle=Math.atan2(dy, dx);
                const overlap = (this.r + player.r) - dist;
                if(overlap > -5) { this.x -= Math.cos(angle) * 2; this.y -= Math.sin(angle) * 2; }

                if(dist < this.view) {
                    let move = true;
                    if (this.type === 'sniper' && dist < 500) move = false;
                    if (this.type === 'boss' && dist < 600) move = false;
                    if (move) {
                        this.x += Math.cos(angle)*this.speed; this.y += Math.sin(angle)*this.speed;
                    }
                    
                    const now = Date.now();
                    let rate = 1500; let count = 1; let spread = 0.05; let spd = 10;
                    
                    let dmg = Math.min(40, 8 + GAME.level * 0.5); 

                    if (this.type === 'rusher') { rate=1000; count=3; spread=0.3; }
                    if (this.type === 'sniper') { rate=2500; spread=0.01; spd=25; dmg*=1.5; }
                    
                    if (this.type === 'boss') {
                        rate = 800; dmg = Math.min(60, 12 + GAME.level);
                        if(now - this.lastShot > rate) {
                            this.lastShot = now;
                            this.shootPattern = Math.floor(Math.random() * 3); 
                            
                            if (this.shootPattern === 1) {
                                const sides = 8 + Math.floor(GAME.level/10); 
                                for(let i=0; i<sides; i++) {
                                    const a = (Math.PI*2 / sides) * i;
                                    bullets.push({x:this.x, y:this.y, vx:Math.cos(a)*8, vy:Math.sin(a)*8, dmg:dmg, color:'#f0f', player:false, life:120});
                                }
                            } 
                            else if (this.shootPattern === 2) {
                                for(let k=0; k<3; k++) {
                                    setTimeout(() => {
                                        if(this.hp<=0) return;
                                        const a = angle + (k * 0.5);
                                        bullets.push({x:this.x, y:this.y, vx:Math.cos(a)*10, vy:Math.sin(a)*10, dmg:dmg, color:'#ff0', player:false, life:100});
                                    }, k*100);
                                }
                            }
                            else {
                                for(let i=0; i<3; i++) {
                                    const s = (Math.random()-0.5)*0.2;
                                    bullets.push({x:this.x, y:this.y, vx:Math.cos(angle+s)*12, vy:Math.sin(angle+s)*12, dmg:dmg, color:'#f55', player:false, life:100});
                                }
                            }
                        }
                    } 
                    else if(now - this.lastShot > rate) {
                        this.lastShot = now;
                        for(let i=0; i<count; i++) {
                            const s = (Math.random()-0.5)*spread;
                            let finalSpd = Math.min(18, spd + GAME.level * 0.05); 
                            bullets.push({
                                x:this.x, y:this.y, vx:Math.cos(angle+s)*finalSpd, vy:Math.sin(angle+s)*finalSpd,
                                dmg:dmg, color:'#f55', player:false, life:100
                            });
                        }
                    }
                }
            }
            draw() {
                if(!onScreen(this.x, this.y, this.r+20)) return;
                ctx.save(); ctx.translate(this.x, this.y); ctx.fillStyle = this.color;
                
                if (this.type === 'basic') {
                    ctx.beginPath(); ctx.moveTo(0, -this.r); ctx.lineTo(this.r, 0); ctx.lineTo(0, this.r); ctx.lineTo(-this.r, 0); ctx.closePath(); ctx.fill();
                    ctx.fillStyle = '#300'; ctx.fillRect(-5,-5,10,10); 
                }
                else if (this.type === 'rusher') { 
                    ctx.beginPath(); ctx.moveTo(15,0); ctx.lineTo(-10,10); ctx.lineTo(-10,-10); ctx.fill(); 
                }
                else if (this.type === 'sniper') { 
                    ctx.fillRect(-15,-15,30,30); 
                }
                else if (this.type === 'boss') {
                    ctx.beginPath(); ctx.arc(0,0,this.r,0,Math.PI*2); ctx.fill(); 
                    ctx.fillStyle='red'; ctx.fillRect(-40,-80,80,10); ctx.fillStyle='#0f0'; ctx.fillRect(-40,-80,80*(this.hp/this.maxHp),10); 
                }
                ctx.restore();
            }
        }

        class Trap {
            constructor(x, y, type) { this.x=x; this.y=y; this.type=type; this.r=25; this.active=true; }
            draw() {
                if(!onScreen(this.x, this.y, 30)) return;
                ctx.save(); ctx.translate(this.x, this.y); 
                
                ctx.globalAlpha = 0.6; 

                let mainColor, teethColor;
                if(this.type==='damage') { mainColor='#500'; teethColor='#f00'; }
                else if(this.type==='slow') { mainColor='#430'; teethColor='#ea0'; }
                else if(this.type==='jam') { mainColor='#005'; teethColor='#0ff'; }

                ctx.strokeStyle = teethColor; ctx.lineWidth = 3;
                ctx.beginPath(); ctx.arc(0,0, this.r, 0, Math.PI*2); ctx.stroke();

                ctx.fillStyle = mainColor;
                ctx.beginPath();
                for(let i=0; i<8; i++) {
                    const angle = (Math.PI*2 / 8) * i;
                    ctx.lineTo(Math.cos(angle)*this.r, Math.sin(angle)*this.r); 
                    ctx.lineTo(Math.cos(angle + 0.4)*10, Math.sin(angle+0.4)*10); 
                }
                ctx.closePath();
                ctx.fill();

                ctx.restore();
            }
        }

        class Machine {
            constructor(x, y, type) { this.x=x; this.y=y; this.type=type; this.dead=false; this.life=type==='turret'?1000:300; }
            update() {
                this.life--; if(this.life<=0 && this.type!=='grenade') this.dead=true;
                if(this.type === 'turret' && this.life % 20 === 0) {
                    let t = bots.find(b => Math.hypot(b.x-this.x, b.y-this.y) < 600);
                    if(t) {
                        const ang = Math.atan2(t.y-this.y, t.x-this.x);
                        AudioSys.shoot(0);
                        bullets.push({x:this.x, y:this.y, vx:Math.cos(ang)*15, vy:Math.sin(ang)*15, dmg:20, color:'#0f0', player:true, life:60});
                    }
                } else if(this.type === 'missile') {
                    let t = bots[0];
                    if(t) {
                        const ang = Math.atan2(t.y-this.y, t.x-this.x);
                        this.x += Math.cos(ang)*12; this.y += Math.sin(ang)*12;
                        if(Math.hypot(t.x-this.x, t.y-this.y) < 30) { this.dead=true; createExplosion(this.x, this.y, 200); }
                    } else this.dead=true;
                } else if(this.type === 'grenade' && this.life <= 0) { this.dead=true; createExplosion(this.x, this.y, 300); }
            }
            draw() { if(onScreen(this.x, this.y, 20)) { ctx.save(); ctx.translate(this.x, this.y); ctx.fillStyle=this.type==='turret'?'#0f0':'#ff0'; ctx.beginPath(); ctx.arc(0,0,15,0,Math.PI*2); ctx.fill(); ctx.restore(); } }
        }

        class Portal {
            constructor(x, y) { this.x=x; this.y=y; this.angle=0; }
            update() { this.angle += 0.05; }
            draw() {
                if(!onScreen(this.x, this.y, 50)) return;
                ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle);
                ctx.strokeStyle = '#b0f'; ctx.lineWidth = 4; ctx.beginPath(); ctx.rect(-20,-20,40,40); ctx.stroke();
                ctx.rotate(this.angle * -2); ctx.beginPath(); ctx.rect(-15,-15,30,30); ctx.stroke(); ctx.restore();
            }
        }

        let player, bots=[], bullets=[], items=[], texts=[], obstacles=[], machines=[], traps=[], exitPortal = null;

        function generateWorld() {
            bots=[]; bullets=[]; items=[]; texts=[]; obstacles=[]; machines=[]; traps=[]; exitPortal = null;
            GAME.botsToSpawn = 0; 
            
            const isBoss = GAME.level % 5 === 0;
            const safeZone = 400;

            if(!isBoss || GAME.level > 20) { 
                for(let i=0; i<30; i++) {
                    let ox, oy, d;
                    do { ox=Math.random()*GAME.width; oy=Math.random()*GAME.height; d=Math.hypot(ox-GAME.width/2, oy-GAME.height/2); } 
                    while(d < safeZone); 
                    obstacles.push({x:ox, y:oy, w:100, h:100});
                }
                
                let trapCount = 5 + Math.floor(GAME.level); 
                for(let i=0; i<trapCount; i++) {
                    let type = Math.random()<0.33 ? 'damage' : (Math.random()<0.5?'slow':'jam');
                    traps.push(new Trap(Math.random()*GAME.width, Math.random()*GAME.height, type));
                }
            }

            for(let i=0; i<10 + (GAME.perks.luck*2); i++) spawnLootAt(Math.random()*GAME.width, Math.random()*GAME.height);

            if(!player) player = new Player(GAME.width/2, GAME.height/2);
            else { player.x = GAME.width/2; player.y = GAME.height/2; } 
            
            if (GAME.boughtShield) {
                player.shield = 100;
                GAME.boughtShield = false;
                showText(player.x, player.y, "ESCUDO ATIVO", "#0af");
            }

            if(isBoss) {
                let bossCount = 1;
                if(GAME.level > 50) bossCount = 2;
                if(GAME.level > 80) bossCount = 3;
                
                for(let b=0; b<bossCount; b++) {
                    const angle = (Math.PI*2 / bossCount) * b;
                    const dist = 800; 
                    bots.push(new Bot(GAME.width/2 + Math.cos(angle)*dist, GAME.height/2 + Math.sin(angle)*dist, 'boss'));
                }
                
                showText(player.x, player.y-100, `${bossCount > 1 ? bossCount + ' CHEF√ïES' : 'CHEF√ÉO'} DETECTADO!`, "red");
                
                let minionCount = 0;
                if(GAME.level > 30) minionCount = Math.floor((GAME.level - 30) * 0.5) + 2;
                if(GAME.level > 60) minionCount += 10; 
                
                if(minionCount > 0) {
                    GAME.botsToSpawn = minionCount;
                    showText(player.x, player.y-140, `+${minionCount} REFOR√áOS`, "#ff0");
                }

            } else {
                GAME.botsToSpawn = Math.max(5, Math.floor(GAME.level * 1.5));
            }
            
            GAME.botsAlive = bots.length + GAME.botsToSpawn;
            updateHUD();
        }

        function manageSpawner() {
            if (GAME.botsToSpawn > 0 && bots.length < GAME.maxBotsOnScreen) {
                let type = 'basic';
                if (GAME.level > 2 && Math.random()<0.3) type = 'rusher';
                if (GAME.level > 5 && Math.random()<0.2) type = 'sniper';
                
                let bx, by, d;
                const safeZone = 500; 
                do { bx=Math.random()*GAME.width; by=Math.random()*GAME.height; d=Math.hypot(bx-player.x, by-player.y); } 
                while(d < safeZone);
                
                bots.push(new Bot(bx, by, type));
                GAME.botsToSpawn--;
            }
        }

        function startGame() {
            AudioSys.init();
            const startLvl = parseInt(document.getElementById('startLevelInput').value) || 1;
            
            GAME.level = startLvl;
            GAME.score = 0;
            GAME.money = 0;
            GAME.perks = { dmg:1, hpMult:1, luck:1 };
            GAME.stats = { basic:0, rusher:0, sniper:0, boss:0 };
            GAME.boughtShield = false;
            
            if (startLvl > 1) {
                GAME.validRank = false;
                GAME.freePerksAvailable = startLvl; 
                player = new Player(GAME.width/2, GAME.height/2); 
                openPreparationShop();
            } else {
                GAME.validRank = !GAME.godMode;
                document.getElementById('startMenu').classList.add('hidden');
                document.getElementById('ui-layer').style.display = 'block';
                initLevel();
            }
        }

        function openPreparationShop() {
            document.getElementById('startMenu').classList.add('hidden');
            document.getElementById('shopMenu').classList.remove('hidden');
            
            document.getElementById('shopTitle').innerText = "PREPARA√á√ÉO T√ÅTICA";
            document.getElementById('perkSection').classList.remove('hidden');
            document.getElementById('btnNextLevel').classList.add('hidden');
            
            updateShopUI();
        }

        function initLevel() {
            if(loopId) cancelAnimationFrame(loopId);
            document.getElementById('shopMenu').classList.add('hidden');
            document.getElementById('perkSection').classList.remove('hidden');
            document.getElementById('perkMsg').classList.add('hidden');
            document.getElementById('btnNextLevel').classList.add('hidden');
            document.getElementById('freePerksMsg').style.display = 'none'; 
            document.getElementById('ui-layer').style.display = 'block';
            
            document.getElementById('shopTitle').innerText = "MISS√ÉO CUMPRIDA!"; 
            
            document.getElementById('priceShield').innerText = "$200";
            document.getElementById('priceShield').style.color = "#0af";
            document.getElementById('btnBuyShield').style.opacity = "1";

            GAME.active = true; GAME.paused = false;
            generateWorld();
            
            if(player) {
                player.hp = player.maxHp; 
                updateHUD(); 
            }

            loop();
        }

        function loop(timestamp) {
            if(!GAME.active) return;
            if(!GAME.paused) update();
            draw();
            drawRadar();
            
            // NUKE FX
            if(nukeEffect.active) {
                nukeEffect.r += 20;
                nukeEffect.alpha -= 0.02;
                if(nukeEffect.alpha <= 0) nukeEffect.active = false;
            }

            loopId = requestAnimationFrame(loop);
        }

        function onScreen(x, y, r) {
            return (x + r > GAME.camera.x && x - r < GAME.camera.x + canvas.width &&
                    y + r > GAME.camera.y && y - r < GAME.camera.y + canvas.height);
        }

        function update() {
            if(GAME.shake > 0) GAME.shake *= 0.9;
            
            manageSpawner(); 

            traps.forEach(t => {
                if(t.active && Math.hypot(player.x-t.x, player.y-t.y) < player.r + t.r) {
                    t.active = false; 
                    AudioSys.zap();
                    if(t.type === 'damage') { 
                        let dmg = Math.floor(player.maxHp * 0.15); 
                        player.takeDamage(dmg); 
                        showText(player.x, player.y, "MINA!", "red"); 
                    }
                    if(t.type === 'slow') { player.slowTimer = 180; showText(player.x, player.y, "LENTO!", "#d35400"); }
                    if(t.type === 'jam') { player.jamTimer = 180; showText(player.x, player.y, "TRAVADO!", "#2980b9"); }
                    updateHUD();
                }
            });
            traps = traps.filter(t => t.active); 

            player.update();
            obstacles.forEach(o => checkWall(player, o));
            machines.forEach(m => m.update());
            machines = machines.filter(m => !m.dead);

            if(exitPortal) {
                exitPortal.update();
                if(Math.hypot(player.x - exitPortal.x, player.y - exitPortal.y) < 40) {
                    AudioSys.pickup();
                    levelComplete();
                }
            }

            bots.forEach(b => { b.update(); obstacles.forEach(o => checkWall(b, o)); });
            bots = bots.filter(b => { if(b.hp <= 0) { onBotDeath(b); return false; } return true; });

            for(let i=bullets.length-1; i>=0; i--) {
                let b = bullets[i]; b.x+=b.vx; b.y+=b.vy; b.life--;
                let hit = false;
                obstacles.forEach(o => { if(b.x>o.x && b.x<o.x+o.w && b.y>o.y && b.y<o.y+o.h) hit=true; });
                if(!hit) {
                    if(b.player) {
                        for(let bot of bots) {
                            if(Math.hypot(b.x-bot.x, b.y-bot.y) < bot.r+5) {
                                bot.hp -= b.dmg; hit = true; AudioSys.playTone(100, 'sawtooth', 0.05); break;
                            }
                        }
                    } else {
                        if(Math.hypot(b.x-player.x, b.y-player.y) < player.r+5) { player.takeDamage(b.dmg); hit = true; }
                    }
                }
                if(hit || b.life <= 0) bullets.splice(i, 1);
            }

            items.forEach((item, i) => {
                if(Math.hypot(player.x-item.x, player.y-item.y) < 35) {
                    applyItem(item); items.splice(i, 1); updateHUD();
                }
            });

            texts.forEach((t,i) => { t.y-=1; t.life--; if(t.life<=0) texts.splice(i, 1); });

            GAME.camera.x += (player.x - canvas.width/2 - GAME.camera.x) * 0.1;
            GAME.camera.y += (player.y - canvas.height/2 - GAME.camera.y) * 0.1;
        }

        function checkWall(ent, obs) {
            if (ent.x > obs.x && ent.x < obs.x+obs.w && ent.y > obs.y && ent.y < obs.y+obs.h) {
                if(ent.x < obs.x+10) ent.x = obs.x; else if(ent.x > obs.x+obs.w-10) ent.x = obs.x+obs.w;
                if(ent.y < obs.y+10) ent.y = obs.y; else if(ent.y > obs.y+obs.h-10) ent.y = obs.y+obs.h;
            }
        }

        function onBotDeath(bot) {
            GAME.botsAlive--; 
            
            // S√≥ conta killstreak se N√ÉO foi morto por Nuke
            if(!bot.killedByNuke) {
                GAME.killStreak++; 
            }
            
            GAME.money += (bot.type==='boss'?500:50); GAME.score += 50; 
            GAME.stats[bot.type]++;
            
            // RNG DE HP (Chance de dropar vida)
            let hpVal = 0.01; 
            if (bot.type === 'boss') hpVal = 0.30;
            else {
                const r = Math.random();
                if(r < 0.60) hpVal = 0.01;      // 60% chance de 1%
                else if(r < 0.85) hpVal = 0.05; // 25% chance de 5%
                else if(r < 0.98) hpVal = 0.10; // 13% chance de 10%
                else hpVal = 0.15;              // 2% chance de 15% (Raro)
            }
            
            items.push({x:bot.x, y:bot.y, type:'hp', val: hpVal});
            
            if(GAME.killStreak >= 3) { GAME.nukeReady=true; updateNuke(); showText(player.x, player.y-50, "NUCLEAR PRONTA!", "red"); }
            if(GAME.botsAlive <= 0 && GAME.botsToSpawn <= 0) spawnPortal(GAME.width/2, GAME.height/2);
            updateHUD();
        }

        function spawnPortal(x, y) {
            exitPortal = new Portal(x, y);
            showText(player.x, player.y - 100, "PORTAL ABERTO!", "#b0f");
            AudioSys.playTone(400, 'sine', 1);
        }

        function spawnLootAt(x, y) {
            const types = ['ammo', 'shield', 'weapon'];
            const t = types[Math.floor(Math.random()*types.length)];
            items.push({x:x, y:y, type:t});
        }

        function applyItem(item) {
            AudioSys.pickup();
            let txt="", col="#fff";
            
            if(item.type==='hp') { 
                const val = item.val || 0.01;
                const healAmt = player.maxHp * val; 
                player.hp = Math.min(player.maxHp, player.hp + healAmt); 
                
                let pct = Math.round(val * 100);
                txt="VIDA +" + pct + "%"; 
                if(pct===1) col="#aaa";
                else if(pct===5) col="#fff";
                else if(pct===10) col="#ffaa00";
                else if(pct===15) col="#ff0000";
                else if(pct===30) col="#00ff00";
            }
            else if(item.type==='ammo') { 
                WEAPONS[1].ammo = Math.min(WEAPONS[1].max, WEAPONS[1].ammo + 40); 
                WEAPONS[2].ammo = Math.min(WEAPONS[2].max, WEAPONS[2].ammo + 15); 
                txt="RIFLE"; col="#ff0"; 
            }
            else if(item.type==='shield') { player.shield=100; txt="ESCUDO"; col="#0af"; }
            else if(item.type==='weapon') { player.wIdx=2; WEAPONS[2].ammo = WEAPONS[2].max; txt="SHOTGUN"; col="#f0f"; updateHUD(); }
            showText(player.x, player.y, txt, col);
        }

        function createExplosion(x, y, dmg) {
            GAME.shake=20; showText(x, y, "BOOM!", "orange");
            bots.forEach(b => { if(Math.hypot(b.x-x, b.y-y) < 200) { b.hp-=dmg; showText(b.x, b.y, dmg, '#fff'); } });
        }

        function useNuke(e) {
            if(e) { e.preventDefault(); e.stopPropagation(); }
            if(!GAME.nukeReady) return;
            
            nukeEffect = { active: true, r: 10, alpha: 1.0 };
            GAME.shake=60; 
            
            bots.forEach(b => { 
                b.killedByNuke = true; // Marca que morreu por nuke
                if (b.type === 'boss') {
                    // Dano percentual em chefes (30% da vida MAX)
                    let dmg = b.maxHp * 0.30;
                    b.hp -= dmg;
                    showText(b.x, b.y, Math.round(dmg), "red");
                } else {
                    // Insta-kill em bots normais
                    b.hp = 0; 
                    showText(b.x, b.y, "INSTA-KILL", "red"); 
                }
            });
            GAME.nukeReady=false; GAME.killStreak=0; updateNuke();
            AudioSys.shoot(2);
        }

        function spawnMachine(e, type) {
            if(e) { e.preventDefault(); e.stopPropagation(); }
            if(GAME.inv[type] > 0) { GAME.inv[type]--; machines.push(new Machine(player.x, player.y, type)); updateHUD(); }
        }

        function draw() {
            ctx.fillStyle = '#111'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.save(); ctx.translate(-Math.floor(GAME.camera.x), -Math.floor(GAME.camera.y));

            const theme = Math.floor((GAME.level-1)/5);
            ctx.fillStyle = theme===3 ? '#210' : '#111'; ctx.fillRect(0,0,GAME.width, GAME.height);
            
            ctx.strokeStyle = 'rgba(255,255,255,0.05)'; ctx.lineWidth = 2;
            ctx.beginPath();
            let startX = Math.floor(GAME.camera.x/200)*200;
            let startY = Math.floor(GAME.camera.y/200)*200;
            for(let i=startX; i<startX+canvas.width+200; i+=200) { ctx.moveTo(i,GAME.camera.y); ctx.lineTo(i,GAME.camera.y+canvas.height); }
            for(let i=startY; i<startY+canvas.height+200; i+=200) { ctx.moveTo(GAME.camera.x,i); ctx.lineTo(GAME.camera.x+canvas.width,i); }
            ctx.stroke();

            if(exitPortal) exitPortal.draw();

            items.forEach(i => { if(onScreen(i.x, i.y, 20)) {
                ctx.fillStyle = i.type==='hp'?'#0f0':(i.type==='ammo'?'#ff0':'#00f');
                ctx.beginPath(); ctx.arc(i.x, i.y, 10, 0, Math.PI*2); ctx.fill();
            }});

            obstacles.forEach(o => { if(onScreen(o.x+o.w/2, o.y+o.h/2, o.w)) {
                ctx.fillStyle=o.c || '#333'; ctx.fillRect(o.x,o.y,o.w,o.h); ctx.strokeStyle='#555'; ctx.strokeRect(o.x,o.y,o.w,o.h);
            }});

            traps.forEach(t => t.draw());

            machines.forEach(m => m.draw());
            bots.forEach(b => b.draw());
            player.draw();
            bullets.forEach(b => { if(onScreen(b.x, b.y, 10)) {
                ctx.fillStyle=b.color; ctx.beginPath(); ctx.arc(b.x,b.y,4,0,Math.PI*2); ctx.fill(); 
            }});
            
            if(nukeEffect.active) {
                ctx.save();
                ctx.globalAlpha = nukeEffect.alpha;
                ctx.beginPath(); ctx.arc(player.x, player.y, nukeEffect.r, 0, Math.PI*2);
                ctx.lineWidth = 20; ctx.strokeStyle = '#fff'; ctx.stroke();
                ctx.fillStyle = '#fff'; ctx.fillRect(GAME.camera.x, GAME.camera.y, canvas.width, canvas.height);
                ctx.restore();
            }

            // TEXTOS COM BORDA
            texts.forEach((t,i) => { 
                ctx.font="bold 20px Arial"; 
                ctx.lineWidth = 3; ctx.strokeStyle = 'black'; ctx.strokeText(t.text, t.x, t.y);
                ctx.fillStyle=t.color; ctx.fillText(t.text, t.x, t.y); 
            });

            ctx.restore();
        }

        function drawRadar() {
            rctx.clearRect(0,0,100,100);
            const sx = 100/GAME.width; const sy = 100/GAME.height;
            rctx.fillStyle='red'; bots.forEach(b=>{ rctx.beginPath(); rctx.arc(b.x*sx, b.y*sy, 3, 0, Math.PI*2); rctx.fill(); });
            rctx.fillStyle='yellow'; items.forEach(i=>{ rctx.fillRect(i.x*sx, i.y*sy, 2, 2); });
            if(exitPortal) { rctx.fillStyle='#b0f'; if(Math.floor(Date.now()/200)%2===0) rctx.fillRect(exitPortal.x*sx-2, exitPortal.y*sy-2, 4, 4); }
            rctx.fillStyle='#0f0'; rctx.beginPath(); rctx.arc(player.x*sx, player.y*sy, 4, 0, Math.PI*2); rctx.fill();
        }

        function updateHUD() {
            document.getElementById('hpBar').style.width = Math.max(0, (player.hp/player.maxHp)*100) + '%';
            document.getElementById('shBar').style.width = Math.max(0, player.shield) + '%';
            document.getElementById('lvlDisp').innerText = `N√çVEL ${GAME.level}`;
            document.getElementById('moneyDisp').innerText = `$${GAME.money}`;
            document.getElementById('scoreDisp').innerText = `${GAME.score}`;
            const w = WEAPONS[player.wIdx];
            document.getElementById('wName').innerText = w.name;
            document.getElementById('wAmmo').innerText = w.ammo;
            document.getElementById('q-turret').innerText = GAME.inv.turret;
            document.getElementById('q-missile').innerText = GAME.inv.missile;
            document.getElementById('q-grenade').innerText = GAME.inv.grenade;
        }

        function updateNuke() { document.getElementById('nuke-container').style.display = GAME.nukeReady ? 'flex' : 'none'; document.getElementById('nuke-btn').style.display = GAME.nukeReady ? 'flex' : 'none'; }
        function getNearestTarget(r) { let t=null,m=r; bots.forEach(b=>{let d=Math.hypot(b.x-player.x, b.y-player.y); if(d<m){m=d;t=b;}}); return t; }
        function showText(x, y, text, color) { texts.push({x, y, text, color, life: 60}); }

        function togglePause() {
            GAME.paused = !GAME.paused;
            if(GAME.paused) {
                document.getElementById('pauseMenu').classList.remove('hidden');
                updateUIText();
            }
            else document.getElementById('pauseMenu').classList.add('hidden');
        }

        function returnToMenu() {
            GAME.active = false;
            GAME.paused = false;
            document.getElementById('pauseMenu').classList.add('hidden');
            document.getElementById('deadMenu').classList.add('hidden');
            document.getElementById('ui-layer').style.display = 'none'; 
            document.getElementById('startMenu').classList.remove('hidden');
        }

        function levelComplete() {
            GAME.active = false;
            document.getElementById('shopMenu').classList.remove('hidden');
            document.getElementById('shopMoney').innerText = GAME.money;
            updateShopUI();
        }

        function updateShopUI() {
            document.getElementById('stat-dmg').innerText = Math.round(GAME.perks.dmg * 100) + "%";
            const percentHP = Math.round(GAME.perks.hpMult * 100);
            document.getElementById('stat-hp').innerText = percentHP + "%";
            document.getElementById('stat-luck').innerText = GAME.perks.luck.toFixed(1) + "x";

            const msg = document.getElementById('freePerksMsg');
            if (GAME.freePerksAvailable > 0) {
                msg.style.display = 'block';
                msg.innerText = `ESCOLHAS RESTANTES: ${GAME.freePerksAvailable}`;
                document.getElementById('btnNextLevel').classList.add('hidden'); 
                document.getElementById('perkSection').classList.remove('hidden'); 
                document.getElementById('perkMsg').classList.add('hidden');
            } else {
                msg.style.display = 'none';
            }
        }

        function nextLevel() { GAME.level++; initLevel(); }
        
        function pickPerk(type) {
            if(type === 'dmg') GAME.perks.dmg += 0.2; 
            if(type === 'hp') { 
                GAME.perks.hpMult += 0.1; // 10% Vida (Linear)
                player.maxHp = player.baseHp * GAME.perks.hpMult; 
                player.hp = player.maxHp; 
                updateHUD(); 
            }
            if(type === 'luck') GAME.perks.luck += 0.5;
            
            if(GAME.freePerksAvailable > 0) {
                GAME.freePerksAvailable--;
                updateShopUI();
                
                if(GAME.freePerksAvailable === 0) {
                    document.getElementById('perkSection').classList.add('hidden');
                    const btn = document.getElementById('btnNextLevel');
                    btn.classList.remove('hidden');
                    btn.innerText = "INICIAR MISS√ÉO";
                    btn.onclick = initLevel; 
                }
            } else {
                updateShopUI();
                document.getElementById('perkSection').classList.add('hidden');
                document.getElementById('perkMsg').classList.remove('hidden');
                const btn = document.getElementById('btnNextLevel');
                btn.classList.remove('hidden');
                btn.innerText = "PR√ìXIMA MISS√ÉO";
                btn.onclick = nextLevel;
            }
        }

        function buyItem(type, cost) {
            if(GAME.money >= cost) {
                if(type === 'shield') {
                    if(!GAME.boughtShield) {
                        GAME.money -= cost;
                        GAME.boughtShield = true;
                        document.getElementById('shopMoney').innerText = GAME.money;
                        document.getElementById('priceShield').innerText = "COMPRADO";
                        document.getElementById('priceShield').style.color = "#0f0";
                        document.getElementById('btnBuyShield').style.opacity = "0.5";
                    }
                } else if(type === 'nuke') {
                    if(!GAME.nukeReady) {
                        GAME.money -= cost;
                        GAME.nukeReady = true;
                        document.getElementById('shopMoney').innerText = GAME.money;
                    }
                } else {
                    GAME.money -= cost; 
                    GAME.inv[type]++; 
                    document.getElementById('shopMoney').innerText = GAME.money; 
                }
            }
        }
        function gameOver() {
            GAME.active = false; document.getElementById('deadMenu').classList.remove('hidden');
            document.getElementById('finalScore').innerText = `SCORE: ${GAME.score}`;
            document.getElementById('finalLevelDisplay').innerText = `N√çVEL ALCAN√áADO: ${GAME.level}`;
            document.getElementById('reportTable').innerHTML = `<tr><td>Grunts</td><td>${GAME.stats.basic}</td></tr><tr><td>Rushers</td><td>${GAME.stats.rusher}</td></tr><tr><td>Snipers</td><td>${GAME.stats.sniper}</td></tr><tr><td>Chefes</td><td>${GAME.stats.boss}</td></tr>`;
            
            if (GAME.validRank) {
                document.getElementById('rankForm').classList.remove('hidden');
                document.getElementById('noRankMsg').classList.add('hidden');
                document.getElementById('playerNameInput').value = '';
                document.getElementById('btnSaveScore').classList.remove('hidden');
                document.getElementById('playerNameInput').classList.remove('hidden');
                document.getElementById('saveMsg').classList.add('hidden');
            } else {
                document.getElementById('rankForm').classList.add('hidden');
                document.getElementById('noRankMsg').classList.remove('hidden');
            }
        }
        function setColor(c, el) { GAME.playerColor = c; document.querySelectorAll('.c-opt').forEach(d => d.classList.remove('selected')); el.classList.add('selected'); }

        function getScores() {
            const s = localStorage.getItem('neonOps_scores');
            return s ? JSON.parse(s) : [];
        }

        function saveCurrentScore() {
            if(!GAME.validRank) return; 

            const name = document.getElementById('playerNameInput').value.trim() || "AN√îNIMO";
            let scores = getScores();
            scores.push({ name: name, level: GAME.level, score: GAME.score });
            
            scores.sort((a, b) => {
                if(b.level !== a.level) return b.level - a.level;
                return b.score - a.score;
            });

            scores = scores.slice(0, 10);
            localStorage.setItem('neonOps_scores', JSON.stringify(scores));

            document.getElementById('btnSaveScore').classList.add('hidden');
            document.getElementById('playerNameInput').classList.add('hidden');
            document.getElementById('saveMsg').classList.remove('hidden');
        }

        function showLeaderboard() {
            const scores = getScores();
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = '';
            
            if(scores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#aaa;">Nenhum registro ainda</td></tr>';
            } else {
                scores.forEach((s, i) => {
                    let color = '#fff';
                    if(i===0) color='#ff0'; 
                    else if(i===1) color='#ccc'; 
                    else if(i===2) color='#b08d55'; 
                    
                    const row = `<tr>
                        <td style="color:${color}">${i+1}</td>
                        <td style="color:${color}">${s.name}</td>
                        <td style="color:${color}">${s.level}</td>
                        <td style="color:${color}">${s.score}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            }

            document.getElementById('startMenu').classList.add('hidden');
            document.getElementById('leaderboardMenu').classList.remove('hidden');
        }

        function closeLeaderboard() {
            document.getElementById('leaderboardMenu').classList.add('hidden');
            document.getElementById('startMenu').classList.remove('hidden');
        }

        function toggleGodMode() {
            GAME.godMode = !GAME.godMode;
            const btn = document.getElementById('btnGodMode');
            if(GAME.godMode) {
                btn.innerText = "MODO DEUS: ATIVADO";
                btn.style.borderColor = "#ffd700";
                btn.style.color = "#ffd700";
            } else {
                btn.innerText = "MODO DEUS: DESATIVADO";
                btn.style.borderColor = "#555";
                btn.style.color = "white";
            }
        }

        function registerJoystick(elmId, type) {
            const el = document.getElementById(elmId); const knob = el.querySelector('.knob');
            el.addEventListener('touchstart', e => { e.preventDefault(); const t = e.changedTouches[0]; INPUT[type].id = t.identifier; INPUT[type].active = true; updateJoy(t, centerFromRect(el), el.offsetWidth/2, knob, type); });
            el.addEventListener('touchmove', e => { e.preventDefault(); for(let i=0; i<e.changedTouches.length; i++) { if(e.changedTouches[i].identifier === INPUT[type].id) updateJoy(e.changedTouches[i], centerFromRect(el), el.offsetWidth/2, knob, type); } });
            const end = e => { for(let i=0; i<e.changedTouches.length; i++) { if(e.changedTouches[i].identifier === INPUT[type].id) { INPUT[type].active = false; knob.style.transform = `translate(0,0)`; INPUT[type].x=0; INPUT[type].y=0; } } };
            el.addEventListener('touchend', end); el.addEventListener('touchcancel', end);
        }
        function centerFromRect(el) { const r = el.getBoundingClientRect(); return {x: r.left + r.width/2, y: r.top + r.height/2}; }
        function updateJoy(t, center, maxR, knob, type) {
            let dx = t.clientX - center.x; let dy = t.clientY - center.y; const dist = Math.hypot(dx, dy);
            if(dist > maxR) { dx = (dx/dist)*maxR; dy = (dy/dist)*maxR; }
            knob.style.transform = `translate(${dx}px, ${dy}px)`; INPUT[type].x = dx/maxR; INPUT[type].y = dy/maxR;
        }
        registerJoystick('joy-move', 'move'); registerJoystick('joy-aim', 'aim'); registerJoystick('joy-single', 'single'); 

        function applyControlMode() {
            const mMove = document.getElementById('joy-move');
            const mAim = document.getElementById('joy-aim');
            const mSingle = document.getElementById('joy-single');
            const btnFire = document.getElementById('fire-btn');
            const btnW = document.getElementById('swapBtn');
            const machines = document.querySelector('.machines'); 
            
            mMove.className = 'joy-zone hidden'; mAim.className = 'joy-zone hidden'; mSingle.className = 'joy-zone hidden'; btnFire.className = 'hidden';

            if(GAME.controlMode === 'dual') {
                mMove.className = GAME.inverted ? 'joy-zone pos-right' : 'joy-zone pos-left';
                mAim.className = GAME.inverted ? 'joy-zone pos-left' : 'joy-zone pos-right';
                
                btnW.style.right = GAME.inverted ? 'auto' : '20px'; btnW.style.left = GAME.inverted ? '20px' : 'auto';
                machines.style.right = GAME.inverted ? 'auto' : '15px'; machines.style.left = GAME.inverted ? '15px' : 'auto';

            } else if (GAME.controlMode === 'single_auto') {
                mSingle.className = 'joy-zone pos-center';
                btnW.style.right = GAME.inverted ? 'auto' : '20px'; btnW.style.left = GAME.inverted ? '20px' : 'auto';
                machines.style.right = GAME.inverted ? 'auto' : '15px'; machines.style.left = GAME.inverted ? '15px' : 'auto';

            } else if (GAME.controlMode === 'single_manual') {
                mSingle.className = GAME.inverted ? 'joy-zone pos-right' : 'joy-zone pos-left';
                btnFire.className = '';
                btnFire.style.left = GAME.inverted ? '40px' : 'auto'; btnFire.style.right = GAME.inverted ? 'auto' : '40px';
                btnW.style.left = GAME.inverted ? 'auto' : '20px'; btnW.style.right = GAME.inverted ? '20px' : 'auto';
                machines.style.left = GAME.inverted ? 'auto' : '15px'; machines.style.right = GAME.inverted ? '15px' : 'auto'; 
            }
            updateUIText();
        }

        function updateUIText() {
            let mTxt = "DUPLO";
            if(GAME.controlMode === 'single_auto') mTxt = "√öNICO (AUTO)";
            if(GAME.controlMode === 'single_manual') mTxt = "√öNICO (MANUAL)";
            let sTxt = GAME.inverted ? "LADO: INVERTIDO" : "LADO: PADR√ÉO";

            document.getElementById('btnModeStart').innerText = "CONTROLE: " + mTxt;
            document.getElementById('btnModePause').innerText = "CONTROLE: " + mTxt;
            document.getElementById('btnSwapStart').innerText = sTxt;
            document.getElementById('btnSwapPause').innerText = sTxt;
        }

        function cycleControlMode() {
            if(GAME.controlMode === 'dual') GAME.controlMode = 'single_auto';
            else if(GAME.controlMode === 'single_auto') GAME.controlMode = 'single_manual';
            else GAME.controlMode = 'dual';
            applyControlMode();
        }

        function toggleSide() { GAME.inverted = !GAME.inverted; applyControlMode(); }

        document.getElementById('swapBtn').addEventListener('touchstart', e => { e.preventDefault(); player.wIdx = (player.wIdx+1) % WEAPONS.length; updateHUD(); });
        document.getElementById('fire-btn').addEventListener('touchstart', e => { e.preventDefault(); INPUT.manualFire = true; });
        document.getElementById('fire-btn').addEventListener('touchend', e => { e.preventDefault(); INPUT.manualFire = false; });

        updateUIText(); 

    </script>
</body>
</html>