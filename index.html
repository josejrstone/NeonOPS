<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Ops: Ultimate Warfare</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; touch-action: none; }
        body { background: #000; overflow: hidden; font-family: 'Rajdhani', sans-serif; color: white; }
        canvas { display: block; background: #111; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: none; }
        .top-bar { position: absolute; top: 10px; left: 10px; right: 10px; display: flex; justify-content: space-between; align-items: flex-start; pointer-events: auto; }
        .bars { display: flex; flex-direction: column; gap: 4px; pointer-events: none; }
        .bar-bg { width: 150px; height: 14px; background: #222; border: 1px solid #555; transform: skewX(-15deg); }
        .hp-fill { width: 100%; height: 100%; background: #f00; transition: width 0.1s linear; } 
        .sh-fill { width: 0%; height: 100%; background: #00aaff; box-shadow: 0 0 10px #00aaff; }
        .info { text-align: right; text-shadow: 1px 1px 2px black; pointer-events: none; }
        .lvl { font-size: 24px; color: #ffeb3b; font-weight: bold; display: block;}
        .score { font-size: 18px; color: #fff; display: block; }
        .money { font-size: 20px; color: #0f0; display: block;}
        #pause-btn { background: rgba(0,0,0,0.5); border: 2px solid #fff; color: white; width: 45px; height: 45px; border-radius: 8px; font-weight: bold; font-size: 20px; display: flex; justify-content: center; align-items: center; cursor: pointer; pointer-events: auto; margin-left: 10px; }
        #radar { position: absolute; top: 70px; left: 10px; width: 100px; height: 100px; background: rgba(0, 20, 0, 0.6); border: 2px solid #0f0; border-radius: 50%; pointer-events: none; overflow: hidden; }
        #radar-canvas { width: 100%; height: 100%; }
        .machines { position: absolute; right: 15px; top: 90px; display: flex; flex-direction: column; gap: 15px; pointer-events: auto; }
        .m-icon { width: 50px; height: 50px; background: rgba(0,0,0,0.7); border: 2px solid #0ff; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: 24px; position: relative; }
        .m-icon:active { transform: scale(0.9); background: rgba(0,255,255,0.3); }
        .m-qty { position: absolute; bottom: -5px; right: -5px; background: #f00; font-size: 12px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        #nuke-btn { position: absolute; top: 120px; left: 50%; transform: translateX(-50%); width: 80px; height: 80px; background: radial-gradient(#ff0, #f00); border: 4px solid #fff; border-radius: 50%; display: none; justify-content: center; align-items: center; font-size: 40px; pointer-events: auto; animation: pulse 0.5s infinite; box-shadow: 0 0 25px #f00; z-index: 50; }
        .w-btn { position: absolute; bottom: 180px; width: 75px; height: 75px; border-radius: 50%; background: rgba(0,0,0,0.6); border: 2px solid #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; pointer-events: auto; z-index: 20; transition: all 0.3s; }
        .w-name { font-size: 11px; font-weight: bold; } .w-ammo { font-size: 18px; }
        #fire-btn { position: absolute; bottom: 40px; width: 100px; height: 100px; border-radius: 50%; background: rgba(255, 50, 50, 0.4); border: 4px solid #f00; display: flex; justify-content: center; align-items: center; pointer-events: auto; z-index: 20; box-shadow: 0 0 15px #f00; font-weight: bold; font-size: 22px; transition: all 0.3s; }
        #fire-btn:active { background: rgba(255, 50, 50, 0.7); transform: scale(0.95); }
        .joy-zone { position: absolute; bottom: 40px; width: 150px; height: 150px; background: rgba(255, 255, 255, 0.05); border-radius: 50%; border: 2px dashed rgba(255, 255, 255, 0.15); pointer-events: auto; display: flex; justify-content: center; align-items: center; transition: all 0.3s; }
        .knob { width: 60px; height: 60px; background: rgba(0, 255, 255, 0.4); border-radius: 50%; pointer-events: none; }
        .k-red { background: rgba(255, 50, 50, 0.4); } .k-green { width: 80px; height: 80px; background: rgba(0, 255, 0, 0.4); }
        .pos-left { left: 30px; right: auto; } .pos-right { right: 30px; left: auto; } .pos-center { left: 50%; transform: translateX(-50%); }
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 10, 15, 0.98); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; pointer-events: auto; overflow-y: auto; padding: 20px; }
        .hidden { display: none !important; }
        .btn { background: linear-gradient(45deg, #00aaff, #0055ff); border: none; padding: 12px 25px; color: white; font-family: 'Rajdhani'; font-size: 18px; font-weight: bold; margin: 8px; border-radius: 5px; min-width: 260px; cursor: pointer; }
        .btn:active { transform: scale(0.95); }
        .btn-green { background: linear-gradient(45deg, #00aa00, #00ff00); color: black; }
        .btn-red { background: linear-gradient(45deg, #aa0000, #ff0000); color: white; }
        .btn-shop { background: #333; border: 1px solid #555; display: flex; justify-content: space-between; align-items: center; width: 280px; padding: 10px; margin: 5px 0; cursor: pointer;}
        .perk-container { display: flex; gap: 8px; }
        .perk { background: #222; border: 1px solid #444; padding: 10px; border-radius: 8px; width: 85px; text-align: center; cursor: pointer;}
        .perk:active { border-color: #0ff; background: #333; }
        .report-table { width: 100%; max-width: 300px; border-collapse: collapse; margin-bottom: 20px; color: #ccc; }
        .report-table td { padding: 5px; border-bottom: 1px solid #333; }
        .report-table td:last-child { text-align: right; color: #fff; font-weight: bold; }
        .code-display { background: #222; border: 1px solid #555; color: #0f0; padding: 10px; font-family: monospace; font-size: 18px; margin-bottom: 5px; width: 260px; text-align: center; }
        .lobby-box { border: 1px solid #444; padding: 15px; border-radius: 10px; width: 300px; margin: 10px; background: rgba(255,255,255,0.05); }
        @keyframes pulse { 0% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.1); box-shadow: 0 0 20px red; } 100% { transform: translateX(-50%) scale(1); } }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="ui-layer">
        <div class="top-bar">
            <div style="display:flex; align-items:center;">
                <div class="bars"><div class="bar-bg"><div class="hp-fill" id="hpBar"></div></div><div class="bar-bg" style="width: 150px; height: 8px; margin-top:4px;"><div class="sh-fill" id="shBar"></div></div></div>
                <div id="pause-btn" onclick="togglePause()">||</div>
            </div>
            <div class="info"><div class="lvl" id="lvlDisp">N√çVEL 1</div><div class="score" id="scoreDisp">0 PTS</div><div class="money" id="moneyDisp">$0</div></div>
        </div>
        <div id="status-effects" style="position:absolute;top:70px;left:50%;transform:translateX(-50%);display:flex;gap:10px;"></div>
        <div id="radar"><canvas id="radar-canvas"></canvas></div>
        <div id="nuke-btn" ontouchstart="useNuke(event)" onmousedown="useNuke(event)">‚ò¢Ô∏è</div>
        <div class="machines">
            <div class="m-icon" onclick="spawnMachine('turret')">üî´<div class="m-qty" id="q-turret">0</div></div>
            <div class="m-icon" onclick="spawnMachine('missile')">üöÄ<div class="m-qty" id="q-missile">0</div></div>
            <div class="m-icon" onclick="spawnMachine('grenade')">üí£<div class="m-qty" id="q-grenade">0</div></div>
        </div>
        <div class="w-btn right" id="swapBtn"><div class="w-name" id="wName">PISTOLA</div><div class="w-ammo" id="wAmmo">‚àû</div></div>
        <div id="fire-btn" class="hidden">TIRO</div>
        <div id="joy-move" class="joy-zone pos-left"><div class="knob" id="knob-move"></div></div>
        <div id="joy-aim" class="joy-zone pos-right"><div class="knob k-red" id="knob-aim"></div></div>
        <div id="joy-single" class="joy-zone pos-center hidden"><div class="knob k-green" id="knob-single"></div></div>
    </div>

    <div id="startMenu" class="modal">
        <h1>NEON OPS<br><span style="font-size:16px; color:white;">WARFARE</span></h1>
        
        <div style="text-align:center; width:100%; max-width:400px;">
            <div style="border: 1px solid #444; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <button class="btn btn-green" onclick="initSolo()">JOGAR SOLO</button>
            </div>
            
            <div class="lobby-box">
                <h3 style="color:#f0f; margin-bottom:10px;">MULTIPLAYER</h3>
                <button class="btn" onclick="createRoom()">CRIAR SALA</button>
                <div style="margin:5px; color:#aaa;">- OU -</div>
                <input type="text" id="joinCode" class="code-display" placeholder="C√ìDIGO DA SALA" style="width:100%">
                <button class="btn btn-shop" onclick="joinRoom()">ENTRAR NA SALA</button>
                <p id="lobbyMsg" style="color:yellow; font-size:12px; margin-top:5px;"></p>
            </div>

            <div style="display:flex; flex-direction:column; gap:10px; margin-top:20px; align-items:center;">
                <button class="btn btn-shop" style="width:250px; font-size:14px;" id="btnModeStart" onclick="cycleControlMode()">CONTROLE: DUPLO</button>
                <button class="btn btn-shop" style="width:250px; font-size:14px;" id="btnSwapStart" onclick="toggleSide()">LADO: PADR√ÉO</button>
            </div>
        </div>
    </div>

    <div id="lobbyWait" class="modal hidden">
        <h1>SALA DE ESPERA</h1>
        <div style="background:#222; padding:15px; border-radius:10px; text-align:center;">
            <p style="color:#aaa;">C√ìDIGO DA SALA</p>
            <h2 id="roomCodeDisplay" style="color:#0f0; margin:10px 0; user-select: text;">...</h2>
            <button class="btn btn-shop" style="width:auto;" onclick="copyRoomCode()">COPIAR C√ìDIGO</button>
        </div>
        <div class="lobby-box" id="playerList" style="margin:20px 0;"></div>
        <button id="btnStartMulti" class="btn btn-green hidden" onclick="startMultiGame()">INICIAR MISS√ÉO</button>
        <button class="btn btn-red" onclick="location.reload()">VOLTAR</button>
    </div>

    <div id="pauseMenu" class="modal hidden">
        <h1>PAUSA</h1>
        <button class="btn" onclick="togglePause()">CONTINUAR</button>
        <button class="btn btn-shop" id="btnModePause" style="justify-content:center;" onclick="cycleControlMode()">MUDAR CONTROLES</button>
        <button class="btn btn-shop" id="btnSwapPause" style="justify-content:center;" onclick="toggleSide()">INVERTER LADOS</button>
        <button class="btn btn-red" onclick="returnToMenu()">SAIR</button>
    </div>

    <div id="shopMenu" class="modal hidden">
        <h2>MISS√ÉO CUMPRIDA!</h2>
        <p id="waitText" class="hidden" style="color:#0ff; animation:pulse 1s infinite;">AGUARDANDO HOST...</p>
        <div id="shopContent">
            <div style="display:flex; gap:15px; font-size:14px; margin-bottom:10px; color:#ccc;">
                <div>Dano: <span id="stat-dmg" style="color:#0ff">100%</span></div>
                <div>Vida: <span id="stat-hp" style="color:#0f0">100</span></div>
            </div>
            <div id="perkSection">
                <p style="color:#aaa;">Escolha uma Melhoria:</p>
                <div class="perk-container">
                    <div class="perk" onclick="pickPerk('dmg')">‚öîÔ∏è<br>+20% Dano</div>
                    <div class="perk" onclick="pickPerk('hp')">‚ù§Ô∏è<br>+25 Vida</div>
                    <div class="perk" onclick="pickPerk('luck')">üçÄ<br>+Sorte</div>
                </div>
            </div>
            <h2 style="margin-top:15px; color:#0f0;">LOJA ($<span id="shopMoney">0</span>)</h2>
            <div class="btn-shop" onclick="buyItem('turret', 200)"><span>Torreta</span> <span style="color:#0f0">$200</span></div>
            <div class="btn-shop" onclick="buyItem('missile', 100)"><span>M√≠ssil x3</span> <span style="color:#0f0">$100</span></div>
            <div class="btn-shop" onclick="buyItem('grenade', 50)"><span>Granada x2</span> <span style="color:#0f0">$50</span></div>
            <button class="btn btn-green hidden" id="btnNextLevel" style="margin-top:20px;" onclick="nextLevel()">PR√ìXIMA MISS√ÉO</button>
        </div>
    </div>

    <div id="deadMenu" class="modal hidden">
        <h1 style="color:red">GAME OVER</h1>
        <h2 id="finalScore">SCORE: 0</h2>
        <p id="specMsg" class="hidden" style="color:#aaa; margin-bottom:20px;">Voc√™ caiu. Aguardando sobreviventes...</p>
        <button id="btnExit" class="btn" onclick="returnToMenu()">MENU PRINCIPAL</button>
    </div>

<script>
    // --- SETUP ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d', { alpha: false });
    const radarCanvas = document.getElementById('radar-canvas');
    const rctx = radarCanvas.getContext('2d');
    let loopId = null;

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        radarCanvas.width = 100; radarCanvas.height = 100;
    }
    window.addEventListener('resize', resize);
    resize();

    // --- GLOBALS ---
    const PEER = { id: null, conn: [], isHost: false, instance: null };
    const COLORS = ['#0ff', '#0f0', '#b0f', '#ff0'];
    const GAME = {
        active: false, paused: false, level: 1, width: 2500, height: 2500,
        camera: {x:0, y:0}, shake:0, money:0, score: 0,
        perks: { dmg:1, hpMult:1, luck:1 },
        inv: { turret:0, missile:0, grenade:0 },
        killStreak: 0, nukeReady: false, botsAlive: 0,
        myId: null,
        stats: { basic:0, rusher:0, sniper:0, boss:0 },
        controlMode: 'dual', inverted: false
    };
    const INPUT = { move: {x:0,y:0,active:false,id:null}, aim: {x:0,y:0,active:false,id:null}, single: {x:0,y:0,active:false,id:null}, manualFire: false };
    const WEAPONS = [
        { id:0, name:'PISTOLA', dmg:25, rate:400, speed:15, spread:0.05, count:1, ammo:'‚àû', max:Infinity, color:'#fff' },
        { id:1, name:'RIFLE', dmg:15, rate:100, speed:22, spread:0.1, count:1, ammo:120, max:120, color:'#0ff' },
        { id:2, name:'SHOTGUN', dmg:12, rate:900, speed:18, spread:0.3, count:6, ammo:30, max:30, color:'#ff0' }
    ];

    // --- CLASSES ---
    class Player {
        constructor(id, x, y, color) {
            this.id=id; this.x=x; this.y=y; this.r=20; this.color=color;
            this.hp=100; this.maxHp=100; this.shield=0; this.dead=false;
            this.wIdx=0; this.angle=0; this.lastShot=0; 
            this.regenTimer=0; this.slowTimer=0; this.jamTimer=0;
        }
        update() {
            if(this.dead) return;
            let speedMult = 1;
            if(this.slowTimer>0) { speedMult=0.5; this.slowTimer--; }
            if(this.jamTimer>0) this.jamTimer--;

            if(this.id === GAME.myId) {
                // UI UPDATE FOR LOCAL PLAYER
                document.getElementById('hpBar').style.width = (this.hp/this.maxHp*100)+'%';
                document.getElementById('shBar').style.width = Math.max(0, this.shield)+'%';
                const sDiv = document.getElementById('status-effects');
                let h=''; 
                if(this.slowTimer>0) h+='<div class="status-badge" style="background:#d35400;border:1px solid #fff">LENTO</div>';
                if(this.jamTimer>0) h+='<div class="status-badge" style="background:#2980b9;border:1px solid #fff">TRAVADO</div>';
                sDiv.innerHTML = h;
            }

            // REGEN
            if(this.regenTimer>0) this.regenTimer--;
            else if(this.hp<this.maxHp && this.hp>0) {
                this.hp += 0.05; if(this.hp>this.maxHp) this.hp=this.maxHp;
            }
            if(this.shield>0) { this.shield-=0.166; if(this.shield<0) this.shield=0; }
        }
        draw() {
            if(this.dead && this.id!==GAME.myId) return; // Hide remote dead
            if(!onScreen(this.x, this.y, 50) && this.id!==GAME.myId) return;
            ctx.save(); ctx.translate(this.x, this.y);
            if(this.dead) ctx.globalAlpha=0.5;
            if(this.shield>0 && !this.dead) { ctx.beginPath(); ctx.arc(0,0,28,0,Math.PI*2); ctx.strokeStyle='#0af'; ctx.lineWidth=3; ctx.stroke(); }
            ctx.rotate(this.angle);
            ctx.beginPath(); ctx.arc(0,0,20,0,Math.PI*2); ctx.fillStyle=this.color; ctx.fill();
            ctx.fillStyle='#333'; ctx.fillRect(10,-5,20,10);
            ctx.restore();
            if(!this.dead) { ctx.fillStyle='#fff'; ctx.font="12px Arial"; ctx.fillText(this.id===GAME.myId?"EU":("P"+this.id.substr(-1)), this.x-10, this.y-30); }
        }
    }

    // --- GAME OBJECTS ---
    let players = {}; 
    let bots=[], bullets=[], items=[], obstacles=[], machines=[], traps=[], texts=[];
    let exitPortal = null;

    // --- AUDIO ---
    const AudioSys = {
        ctx: null,
        init: function() { if(!this.ctx) this.ctx=new(window.AudioContext||window.webkitAudioContext)(); },
        play: function(freq, type, dur, vol=0.1) {
            if(!this.ctx) return;
            try { const o=this.ctx.createOscillator(), g=this.ctx.createGain(); o.type=type; o.frequency.setValueAtTime(freq,this.ctx.currentTime); g.gain.setValueAtTime(vol,this.ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.01,this.ctx.currentTime+dur); o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime+dur); } catch(e){}
        }
    };

    // --- CORE LOGIC ---
    function initSolo() {
        console.log("Iniciando Solo...");
        GAME.myId = 'host'; PEER.isHost = true;
        players = {}; players['host'] = new Player('host',0,0,COLORS[0]);
        startGame();
    }

    function createRoom() {
        if(typeof Peer === 'undefined') { alert("Erro de Rede. Verifique conex√£o."); return; }
        const id = "OPS-" + Math.floor(Math.random()*9999);
        PEER.isHost = true; GAME.myId = 'host';
        PEER.instance = new Peer(id);
        PEER.instance.on('open', id => {
            document.getElementById('startMenu').classList.add('hidden');
            document.getElementById('lobbyWait').classList.remove('hidden');
            document.getElementById('roomCodeDisplay').innerText = id;
            document.getElementById('btnStartMulti').classList.remove('hidden');
            players={}; players['host'] = new Player('host',0,0,COLORS[0]);
            updateLobbyList();
        });
        PEER.instance.on('connection', conn => {
            PEER.conn.push(conn);
            conn.on('open', () => {
                const pid = conn.peer; const col = COLORS[PEER.conn.length % 4];
                players[pid] = new Player(pid,0,0,col);
                updateLobbyList();
                conn.send({type:'init', id:pid, color:col});
            });
            conn.on('data', data => handlePacket(data, conn.peer));
        });
    }

    function joinRoom() {
        const code = document.getElementById('joinCode').value.trim().toUpperCase();
        if(!code) return alert("Digite o c√≥digo!");
        const myId = "P-" + Math.floor(Math.random()*9999);
        PEER.instance = new Peer(myId);
        PEER.instance.on('open', id => {
            const conn = PEER.instance.connect(code);
            PEER.conn = [conn]; PEER.isHost = false;
            conn.on('open', () => {
                document.getElementById('startMenu').classList.add('hidden');
                document.getElementById('lobbyWait').classList.remove('hidden');
                document.getElementById('roomCodeDisplay').innerText = code;
                document.getElementById('lobbyMsg').innerText = "Conectado!";
                document.getElementById('btnStartMulti').classList.add('hidden');
            });
            conn.on('data', data => handlePacket(data));
        });
    }

    function handlePacket(data, sender) {
        if(!PEER.isHost) { // CLIENTE
            if(data.type==='init') { GAME.myId=data.id; document.getElementById('lobbyMsg').innerText="Pronto!"; }
            if(data.type==='start') startGame();
            if(data.type==='update') syncState(data.payload);
            if(data.type==='levelComplete') { levelComplete(); document.getElementById('shopContent').classList.add('hidden'); document.getElementById('waitText').classList.remove('hidden'); }
            if(data.type==='nextLevel') nextLevel();
            if(data.type==='gameover') gameOver();
        } else { // HOST
            if(data.type==='input' && players[sender]) applyRemoteInput(players[sender], data.input);
        }
    }

    function startGame() {
        AudioSys.init();
        document.getElementById('startMenu').classList.add('hidden');
        document.getElementById('lobbyWait').classList.add('hidden');
        document.getElementById('ui-layer').style.display = 'block';
        GAME.money=0; GAME.level=1; GAME.score=0;
        initLevel();
    }

    function initLevel() {
        if(loopId) cancelAnimationFrame(loopId);
        document.getElementById('shopMenu').classList.add('hidden');
        document.getElementById('perkSection').classList.remove('hidden');
        document.getElementById('perkMsg').classList.add('hidden');
        document.getElementById('btnNextLevel').classList.add('hidden');
        document.getElementById('shopContent').classList.remove('hidden');
        
        if(PEER.isHost) {
            generateWorld();
            Object.values(players).forEach(p => { 
                p.dead=false; p.hp=p.maxHp; 
                p.x = GAME.width/2 + (Math.random()-0.5)*100;
                p.y = GAME.height/2 + (Math.random()-0.5)*100;
            });
        }
        GAME.active = true; GAME.paused = false;
        loop();
    }

    function loop() {
        if(!GAME.active) return;
        if(!GAME.paused) update();
        draw();
        drawRadar();
        loopId = requestAnimationFrame(loop);
    }

    function update() {
        if(!PEER.isHost) {
            // Cliente envia input
            if(PEER.conn[0] && PEER.conn[0].open) {
                PEER.conn[0].send({ type:'input', input: { 
                    move:INPUT.move, aim:INPUT.aim, single:INPUT.single, 
                    manualFire: INPUT.manualFire || (GAME.controlMode.includes('auto') && (INPUT.single.active||INPUT.aim.active)),
                    mode: GAME.controlMode
                }});
            }
            return;
        }

        // HOST LOGIC
        if(GAME.shake>0) GAME.shake*=0.9;
        
        let live=0;
        Object.values(players).forEach(p => {
            if(p.id===GAME.myId) handleLocalInput(p);
            p.update();
            checkCollisions(p);
            if(!p.dead) live++;
        });

        if(live===0 && Object.keys(players).length>0) { broadcast({type:'gameover'}); gameOver(); return; }

        // Bots
        bots.forEach(b => {
            // Simple AI
            let t=null, min=9999;
            Object.values(players).forEach(p=>{ if(!p.dead){let d=Math.hypot(p.x-b.x,p.y-b.y); if(d<min){min=d; t=p;}} });
            if(t && min < b.view) {
                b.x += Math.cos(Math.atan2(t.y-b.y, t.x-b.x)) * b.speed;
                b.y += Math.sin(Math.atan2(t.y-b.y, t.x-b.x)) * b.speed;
                // Shoot
                if(Date.now()-b.lastShot>1500) {
                    b.lastShot=Date.now();
                    let ang = Math.atan2(t.y-b.y, t.x-b.x);
                    bullets.push({x:b.x, y:b.y, vx:Math.cos(ang)*8, vy:Math.sin(ang)*8, dmg:10, color:'#f55', life:100});
                }
            }
            // Bot Collisions (wall)
            if(b.x<0||b.x>GAME.width||b.y<0||b.y>GAME.height) { b.x=Math.max(20,Math.min(GAME.width-20,b.x)); b.y=Math.max(20,Math.min(GAME.height-20,b.y)); }
        });
        
        // Bullets
        for(let i=bullets.length-1; i>=0; i--) {
            let b=bullets[i]; b.x+=b.vx; b.y+=b.vy; b.life--;
            let hit=false;
            obstacles.forEach(o=>{ if(b.x>o.x && b.x<o.x+o.w && b.y>o.y && b.y<o.y+o.h) hit=true; });
            if(!hit) {
                if(b.player) {
                    for(let bot of bots) { if(Math.hypot(b.x-bot.x, b.y-bot.y)<bot.r+5) { bot.hp-=b.dmg; hit=true; AudioSys.play(100,'sawtooth',0.05); if(bot.hp<=0) onBotDeath(bot); break; } }
                } else {
                    Object.values(players).forEach(p=>{ if(!p.dead && Math.hypot(b.x-p.x, b.y-p.y)<p.r+5) { p.takeDamage(b.dmg); hit=true; } });
                }
            }
            if(hit || b.life<=0) bullets.splice(i,1);
        }

        // Portal
        if(exitPortal) {
            exitPortal.a+=0.1;
            Object.values(players).forEach(p=>{ if(!p.dead && Math.hypot(p.x-exitPortal.x, p.y-exitPortal.y)<40) { AudioSys.pickup(); broadcast({type:'levelComplete'}); levelComplete(); } });
        }

        // Sync
        const payload = {
            players: Object.values(players).map(p=>({id:p.id, x:Math.round(p.x), y:Math.round(p.y), angle:p.angle, hp:p.hp, shield:p.shield, dead:p.dead, color:p.color})),
            bots: bots.map(b=>({x:Math.round(b.x), y:Math.round(b.y), r:b.r, color:b.color})),
            bullets: bullets.map(b=>({x:Math.round(b.x), y:Math.round(b.y), color:b.color})),
            items: items, traps: traps.map(t=>({x:t.x,y:t.y,type:t.type, active:t.active})),
            portal: exitPortal
        };
        PEER.conn.forEach(c => c.send({type:'update', payload:payload}));

        // Camera Host
        const me = players[GAME.myId];
        if(me) { GAME.camera.x+=(me.x-canvas.width/2-GAME.camera.x)*0.1; GAME.camera.y+=(me.y-canvas.height/2-GAME.camera.y)*0.1; }
    }

    function syncState(s) {
        s.players.forEach(rp => {
            if(!players[rp.id]) players[rp.id]=new Player(rp.id,0,0,rp.color);
            let p=players[rp.id]; p.x=rp.x; p.y=rp.y; p.angle=rp.angle; p.hp=rp.hp; p.shield=rp.shield; p.dead=rp.dead; p.color=rp.color;
            if(rp.id===GAME.myId) { 
                GAME.camera.x+=(p.x-canvas.width/2-GAME.camera.x)*0.1; GAME.camera.y+=(p.y-canvas.height/2-GAME.camera.y)*0.1;
                if(p.dead) { document.getElementById('btnExit').classList.add('hidden'); document.getElementById('specMsg').classList.remove('hidden'); document.getElementById('deadMenu').classList.remove('hidden'); }
                else document.getElementById('deadMenu').classList.add('hidden');
            }
        });
        bots=s.bots; bullets=s.bullets; items=s.items; traps=s.traps; exitPortal=s.portal;
    }

    function handleLocalInput(p) {
        let moving = false;
        if(GAME.controlMode.includes('single')) {
            if(INPUT.single.active) { p.x+=INPUT.single.x*4; p.y+=INPUT.single.y*4; p.angle=Math.atan2(INPUT.single.y, INPUT.single.x); moving=true; }
            let t=getNearest(p,500);
            if((GAME.controlMode==='single_auto' && t && moving) || (GAME.controlMode==='single_manual' && INPUT.manualFire)) {
                if(t) p.angle=Math.atan2(t.y-p.y, t.x-p.x);
                shoot(p);
            }
        } else {
            if(INPUT.move.active) { p.x+=INPUT.move.x*4; p.y+=INPUT.move.y*4; if(!INPUT.aim.active) p.angle=Math.atan2(INPUT.move.y,INPUT.move.x); }
            if(INPUT.aim.active) { p.angle=Math.atan2(INPUT.aim.y, INPUT.aim.x); shoot(p); }
        }
        // Boundaries
        p.x=Math.max(20,Math.min(GAME.width-20,p.x)); p.y=Math.max(20,Math.min(GAME.height-20,p.y));
    }

    function applyRemoteInput(p, i) {
        if(i.single && i.single.active) { p.x+=i.single.x*4; p.y+=i.single.y*4; p.angle=Math.atan2(i.single.y,i.single.x); }
        else if(i.move && i.move.active) { p.x+=i.move.x*4; p.y+=i.move.y*4; if(!i.aim.active) p.angle=Math.atan2(i.move.y,i.move.x); }
        if(i.aim && i.aim.active) p.angle=Math.atan2(i.aim.y,i.aim.x);
        
        // Auto Aim Remote
        if(i.mode && i.mode.includes('single')) {
            let t=getNearest(p,500); if(t) p.angle=Math.atan2(t.y-p.y,t.x-p.x);
        }
        if(i.manualFire) shoot(p);
    }

    function shoot(p) {
        if(Date.now()-p.lastShot > 400) { // Rate limit hardcoded for stability
            p.lastShot=Date.now();
            if(p.id===GAME.myId) AudioSys.play(600,'triangle',0.1);
            bullets.push({x:p.x, y:p.y, vx:Math.cos(p.angle)*15, vy:Math.sin(p.angle)*15, dmg:25, color:p.color, player:true, life:60});
        }
    }

    function checkCollisions(p) {
        obstacles.forEach(o=>{ if(p.x>o.x && p.x<o.x+o.w && p.y>o.y && p.y<o.y+o.h) { if(p.x<o.x+10) p.x=o.x; else if(p.x>o.x+o.w-10) p.x=o.x+o.w; if(p.y<o.y+10) p.y=o.y; else if(p.y>o.y+o.h-10) p.y=o.y+o.h; } });
        traps.forEach(t=>{ if(t.active && Math.hypot(p.x-t.x, p.y-t.y)<p.r+30) { t.active=false; AudioSys.play(150,'sawtooth',0.3); p.takeDamage(10); showText(p.x,p.y,"ARMADILHA!","orange"); }});
        items.forEach((it,i)=>{ if(Math.hypot(p.x-it.x, p.y-it.y)<30) { items.splice(i,1); AudioSys.pickup(); if(it.type==='hp') { p.hp=Math.min(100,p.hp+30); showText(p.x,p.y,"VIDA","#0f0"); } else { p.shield=100; showText(p.x,p.y,"ESCUDO","#00f"); } } });
    }

    function generateWorld() {
        bots=[]; obstacles=[]; items=[]; traps=[]; exitPortal=null;
        for(let i=0; i<20; i++) obstacles.push({x:Math.random()*GAME.width, y:Math.random()*GAME.height, w:100, h:100});
        for(let i=0; i<10; i++) items.push({x:Math.random()*GAME.width, y:Math.random()*GAME.height, type:Math.random()>0.5?'hp':'shield'});
        for(let i=0; i<5; i++) traps.push({x:Math.random()*GAME.width, y:Math.random()*GAME.height, type:'damage', active:true});
        
        let count = 5 + GAME.level;
        for(let i=0; i<count; i++) {
            bots.push({x:Math.random()*GAME.width, y:Math.random()*GAME.height, hp:50, r:20, color:'#f00', view:800, speed:2, lastShot:0, type:'basic'});
        }
    }

    function onBotDeath(b) {
        GAME.botsAlive = bots.filter(bt=>bt.hp>0).length;
        GAME.score += 50;
        if(GAME.botsAlive <= 1 && !exitPortal) { // Last one dies
            exitPortal = {x:GAME.width/2, y:GAME.height/2, a:0};
            showText(players[GAME.myId].x, players[GAME.myId].y-100, "PORTAL ABERTO", "#b0f");
        }
    }

    // --- UTILS ---
    function getNearest(p,r) { let t=null,m=r; bots.forEach(b=>{let d=Math.hypot(b.x-p.x, b.y-p.y); if(d<m){m=d;t=b;}}); return t; }
    function onScreen(x,y,r) { return x>GAME.camera.x && x<GAME.camera.x+canvas.width && y>GAME.camera.y && y<GAME.camera.y+canvas.height; }
    function updateLobbyList() { 
        document.getElementById('playerList').innerHTML = Object.values(players).map((p,i)=>`<div style="color:${p.color}">JOGADOR ${i+1} - PRONTO</div>`).join('');
    }
    function showText(x,y,t,c) { texts.push({x:x,y:y,text:t,color:c,life:60}); }
    function gameOver() { GAME.active=false; document.getElementById('deadMenu').classList.remove('hidden'); document.getElementById('specMsg').classList.add('hidden'); document.getElementById('btnExit').classList.remove('hidden'); }
    function nextLevel() { GAME.level++; if(PEER.isHost) { broadcast({type:'nextLevel'}); initLevel(); } }
    function drawRadar() { rctx.clearRect(0,0,100,100); rctx.fillStyle='red'; bots.forEach(b=>{rctx.fillRect(b.x/25,b.y/25,2,2)}); rctx.fillStyle='#0f0'; Object.values(players).forEach(p=>{if(!p.dead)rctx.fillRect(p.x/25,p.y/25,3,3)}); }
    function draw() {
        ctx.fillStyle='#111'; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.save(); ctx.translate(-GAME.camera.x,-GAME.camera.y);
        ctx.strokeStyle='rgba(255,255,255,0.1)'; ctx.beginPath(); 
        for(let i=0; i<GAME.width; i+=200) { ctx.moveTo(i,0); ctx.lineTo(i,GAME.height); }
        for(let i=0; i<GAME.height; i+=200) { ctx.moveTo(0,i); ctx.lineTo(GAME.width,i); }
        ctx.stroke();
        
        if(exitPortal) { ctx.save(); ctx.translate(exitPortal.x,exitPortal.y); ctx.rotate(exitPortal.a); ctx.strokeStyle='#b0f'; ctx.strokeRect(-20,-20,40,40); ctx.restore(); }
        obstacles.forEach(o=>{ if(onScreen(o.x,o.y,100)) { ctx.fillStyle='#333'; ctx.fillRect(o.x,o.y,o.w,o.h); ctx.strokeStyle='#555'; ctx.strokeRect(o.x,o.y,o.w,o.h); }});
        items.forEach(i=>{ ctx.fillStyle=i.type==='hp'?'#0f0':'#00f'; ctx.beginPath(); ctx.arc(i.x,i.y,10,0,Math.PI*2); ctx.fill(); });
        traps.forEach(t=>{ if(t.active) { ctx.fillStyle='#500'; ctx.beginPath(); ctx.arc(t.x,t.y,20,0,Math.PI*2); ctx.fill(); ctx.stroke(); } });
        bots.forEach(b=>{ if(onScreen(b.x,b.y,30)) { ctx.fillStyle=b.color; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); }});
        Object.values(players).forEach(p=>p.draw());
        bullets.forEach(b=>{ ctx.fillStyle=b.color; ctx.beginPath(); ctx.arc(b.x,b.y,4,0,Math.PI*2); ctx.fill(); });
        texts.forEach(t=>{ ctx.fillStyle=t.color; ctx.font="20px Arial"; ctx.fillText(t.text,t.x,t.y); });
        ctx.restore();
    }

    // --- CONTROLS UI ---
    function registerJoy(id, type) {
        const el = document.getElementById(id);
        el.addEventListener('touchstart', e=>{ e.preventDefault(); INPUT[type].active=true; INPUT[type].id=e.changedTouches[0].identifier; moveJoy(e.changedTouches[0], el, type); });
        el.addEventListener('touchmove', e=>{ e.preventDefault(); for(let i=0;i<e.changedTouches.length;i++) if(e.changedTouches[i].identifier===INPUT[type].id) moveJoy(e.changedTouches[i], el, type); });
        const end = e=>{ for(let i=0;i<e.changedTouches.length;i++) if(e.changedTouches[i].identifier===INPUT[type].id) { INPUT[type].active=false; el.querySelector('.knob').style.transform=`translate(0,0)`; INPUT[type].x=0; INPUT[type].y=0; } };
        el.addEventListener('touchend', end); el.addEventListener('touchcancel', end);
    }
    function moveJoy(t, el, type) {
        const r = el.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2, mr=r.width/2;
        let dx=t.clientX-cx, dy=t.clientY-cy, d=Math.hypot(dx,dy);
        if(d>mr) { dx=(dx/d)*mr; dy=(dy/d)*mr; }
        el.querySelector('.knob').style.transform=`translate(${dx}px,${dy}px)`;
        INPUT[type].x=dx/mr; INPUT[type].y=dy/mr;
    }
    registerJoy('joy-move','move'); registerJoy('joy-aim','aim'); registerJoy('joy-single','single');
    
    function applyUI() {
        const m1=document.getElementById('joy-move'), m2=document.getElementById('joy-aim'), m3=document.getElementById('joy-single'), bf=document.getElementById('fire-btn');
        m1.className='joy-zone hidden'; m2.className='joy-zone hidden'; m3.className='joy-zone hidden'; bf.className='hidden';
        if(GAME.controlMode==='dual') { m1.className=GAME.inverted?'joy-zone pos-right':'joy-zone pos-left'; m2.className=GAME.inverted?'joy-zone pos-left':'joy-zone pos-right'; }
        else if(GAME.controlMode==='single_auto') { m3.className='joy-zone pos-center'; }
        else { m3.className=GAME.inverted?'joy-zone pos-right':'joy-zone pos-left'; bf.className=''; bf.style.right=GAME.inverted?'auto':'40px'; bf.style.left=GAME.inverted?'40px':'auto'; }
        
        let txt = GAME.controlMode==='dual'?"DUPLO":(GAME.controlMode==='single_auto'?"√öNICO (AUTO)":"√öNICO (MANUAL)");
        document.getElementById('btnModeStart').innerText = "CONTROLE: "+txt; document.getElementById('btnModePause').innerText = "CONTROLE: "+txt;
        document.getElementById('btnSwapStart').innerText = GAME.inverted?"LADO: INVERTIDO":"LADO: PADR√ÉO"; document.getElementById('btnSwapPause').innerText = GAME.inverted?"LADO: INVERTIDO":"LADO: PADR√ÉO";
    }
    function cycleControlMode() {
        if(GAME.controlMode==='dual') GAME.controlMode='single_auto'; else if(GAME.controlMode==='single_auto') GAME.controlMode='single_manual'; else GAME.controlMode='dual';
        applyUI();
    }
    function toggleSide() { GAME.inverted=!GAME.inverted; applyUI(); }
    function togglePause() { GAME.paused=!GAME.paused; document.getElementById('pauseMenu').classList.toggle('hidden', !GAME.paused); }
    function returnToMenu() { location.reload(); }
    function useNuke(e) { if(e) e.preventDefault(); if(GAME.nukeReady) { GAME.nukeReady=false; document.getElementById('nuke-btn').style.display='none'; bots.forEach(b=>b.hp-=1000); AudioSys.play(50,'sawtooth',1); } }
    function copyRoomCode() { navigator.clipboard.writeText(document.getElementById('roomCodeDisplay').innerText); alert("Copiado!"); }
    
    document.getElementById('fire-btn').addEventListener('touchstart', e=>{e.preventDefault(); INPUT.manualFire=true;});
    document.getElementById('fire-btn').addEventListener('touchend', e=>{e.preventDefault(); INPUT.manualFire=false;});
    
    applyUI();
</script>
</body>
</html>
